<!DOCTYPE html><!--  This site was created in Webflow. https://webflow.com  --><!--  Last Published: Wed Jan 14 2026 07:11:16 GMT+0000 (Coordinated Universal Time)  -->
<html data-wf-page="6965c816c706edb1978686d2" data-wf-site="69658389f59da527c04bcbd4" lang="en">
<head>
  <meta charset="utf-8">
  <title>Military Calculator for BAH, BAS, Base Pay and Financial Health.</title>
  <meta content="Get a forecast of your future BAH and an executive summary of your finances. Calculate your current base pay, and BAH to determine financial health. Get home price average of your next duty location." name="description">
  <meta content="Military Calculator for BAH, BAS, Base Pay and Financial Health." property="og:title">
  <meta content="Get a forecast of your future BAH and an executive summary of your finances. Calculate your current base pay, and BAH to determine financial health. Get home price average of your next duty location." property="og:description">
  <meta content="https://cdn.prod.website-files.com/69658389f59da527c04bcbd4/6966c986c8472ee377c2b9df_ffdcab38d6a982d23413fb95c1452762_PCSUnited.jpg" property="og:image">
  <meta content="Military Calculator for BAH, BAS, Base Pay and Financial Health." property="twitter:title">
  <meta content="Get a forecast of your future BAH and an executive summary of your finances. Calculate your current base pay, and BAH to determine financial health. Get home price average of your next duty location." property="twitter:description">
  <meta property="og:type" content="website">
  <meta content="summary_large_image" name="twitter:card">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <meta content="Webflow" name="generator">
  <link href="css/normalize.css" rel="stylesheet" type="text/css">
  <link href="css/webflow.css" rel="stylesheet" type="text/css">
  <link href="css/pcs-united.webflow.css" rel="stylesheet" type="text/css">
  <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
  <link href="images/favicon.png" rel="shortcut icon" type="image/x-icon">
  <link href="images/webclip.png" rel="apple-touch-icon">
</head>
<body>
  <div class="w-embed w-script"><!--  =========================================================
  PCSUnited ‚Ä¢ Frosted Glass Login Lock (Analyze Page) v1.5
  ‚úÖ Visible by default
  ‚úÖ Hard-mounts to <body> (prevents clipping)
  ‚úÖ Locks ONLY pcs-united.webflow.io/analyze
  ‚úÖ Uses https://theorozcorealty.netlify.app/api/login
=========================================================  -->
    <div id="rs-lock-overlay" aria-hidden="false">
      <div class="rs-lock-centered" role="dialog" aria-labelledby="rs-lock-title" aria-modal="true">
        <div class="rs-lock-card" id="rs-lock-card">
          <h1 id="rs-lock-title">Sign In to Continue</h1>
          <p class="rs-lock-sub">This page is private ‚Äî please enter your credentials.</p>
          <div class="rs-field">
            <input id="rs-email-input" type="email" placeholder="Email Address" autocomplete="email">
          </div>
          <div class="rs-field">
            <input id="rs-pass-input" type="password" placeholder="Password" minlength="8" autocomplete="current-password">
          </div>
          <div class="rs-login-row">
            <button id="rs-login-btn" type="button">Log In</button>
          </div>
          <div class="rs-signup-row">
            <p class="rs-signup-text">Not a Prime Member yet?</p>
            <a class="rs-signup-btn" href="https://pcs-united.webflow.io/user-profile">Sign Up</a>
          </div>
          <p id="rs-lock-msg" class="rs-lock-msg" aria-live="polite"></p>
        </div>
      </div>
    </div>
    <style>
  :root{
    --rs-overlay-bg: rgba(6,10,18,0.55);
    --rs-accent: #8ef3c5;
    --rs-ink: #e9ecff;
    --rs-muted: #a8b0d6;
    --rs-radius: 14px;
  }
  #rs-lock-overlay{
    position:fixed; inset:0;
    width:100%; height:100%;
    z-index:999999;
    display:flex; align-items:center; justify-content:center;
    background:var(--rs-overlay-bg);
    backdrop-filter: blur(12px) saturate(135%);
    -webkit-backdrop-filter: blur(12px) saturate(135%);
    font-family: Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    /* ‚úÖ Visible by default (no ‚Äúwalk through‚Äù) */
    visibility: visible;
    opacity: 1;
    pointer-events: auto;
    transition: opacity .25s ease, visibility .25s ease;
  }
  #rs-lock-overlay.rs-hidden{
    opacity:0 !important;
    pointer-events:none !important;
    visibility:hidden !important;
  }
  .rs-lock-centered{ width:100%; max-width:520px; padding:20px; }
  .rs-lock-card{
    background: rgba(255,255,255,0.035);
    border-radius: var(--rs-radius);
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 18px 60px rgba(3,6,15,0.72);
    padding: 28px 24px;
    color: var(--rs-ink);
  }
  .rs-lock-card h1{ margin:0 0 8px; font-size:20px; font-weight:800; }
  .rs-lock-sub{ margin:0 0 18px; color:var(--rs-muted); font-size:13px; }
  .rs-field{ margin-bottom:14px; }
  #rs-email-input, #rs-pass-input{
    width:100%;
    padding:12px 14px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.09);
    background:rgba(0,0,0,0.18);
    color:var(--rs-ink);
    font-size:16px;
    outline:none;
  }
  #rs-email-input::placeholder, #rs-pass-input::placeholder{ color:var(--rs-muted); }
  #rs-login-btn{
    width:100%;
    padding:12px 16px;
    border-radius:10px;
    border:none;
    background:linear-gradient(180deg,var(--rs-accent),rgba(100,230,190,0.85));
    color:#02110b;
    font-weight:900;
    cursor:pointer;
    font-size:15px;
  }
  #rs-login-btn:disabled{ opacity:.7; cursor:not-allowed; }
  .rs-lock-msg{
    margin-top:12px;
    color:var(--rs-muted);
    font-size:13px;
    min-height:18px;
  }
  .rs-signup-row{
    margin-top:18px;
    padding-top:14px;
    border-top:1px solid rgba(255,255,255,0.07);
    text-align:center;
  }
  .rs-signup-text{ margin:0 0 8px; font-size:13px; color:var(--rs-muted); }
  .rs-signup-btn{
    display:inline-block;
    padding:8px 16px;
    border-radius:999px;
    border:1px solid rgba(142,243,197,0.65);
    background:rgba(255,255,255,0.02);
    color:var(--rs-accent);
    font-size:13px;
    font-weight:900;
    text-decoration:none;
    transition: background .2s ease, box-shadow .2s ease, transform .2s ease;
  }
  .rs-signup-btn:hover{
    background:rgba(142,243,197,0.10);
    box-shadow:0 12px 30px rgba(0,0,0,0.75);
    transform:translateY(-1px);
  }
</style>
    <script>
(function(){
  "use strict";
  // ‚úÖ Lock ONLY this exact page
  const isPCS = location.hostname === "pcs-united.webflow.io";
  const isAnalyze = location.pathname === "/analyze";
  if (!isPCS || !isAnalyze) {
    const el = document.getElementById("rs-lock-overlay");
    if (el) el.remove();
    return;
  }
  const API_BASE = "https://theorozcorealty.netlify.app/api";
  const overlay  = document.getElementById("rs-lock-overlay");
  const msg      = document.getElementById("rs-lock-msg");
  const emailInp = document.getElementById("rs-email-input");
  const passInp  = document.getElementById("rs-pass-input");
  const loginBtn = document.getElementById("rs-login-btn");
  const card     = document.getElementById("rs-lock-card");
  if (!overlay) return;
  // ‚úÖ Hard-mount to body so Webflow wrappers can't clip it
  try { document.body.appendChild(overlay); } catch(e){}
  // ‚úÖ Force visible
  overlay.classList.remove("rs-hidden");
  overlay.style.visibility = "visible";
  overlay.style.opacity = "1";
  overlay.style.pointerEvents = "auto";
  overlay.removeAttribute("aria-hidden");
  console.log("[PCS LOCK] Mounted:", location.hostname + location.pathname);
  function showMsg(text, isError){
    msg.textContent = text || "";
    msg.style.color = isError ? "#ffb3b3" : "var(--rs-muted)";
  }
  function unlock(){
    overlay.classList.add("rs-hidden");
    overlay.style.visibility = "hidden";
    overlay.style.opacity = "0";
    overlay.style.pointerEvents = "none";
    overlay.setAttribute("aria-hidden","true");
    console.log("[PCS LOCK] Unlocked");
  }
  async function loginWithServer(email, password){
    let res, data;
    try{
      res = await fetch(`${API_BASE}/login`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ email, password })
      });
      data = await res.json().catch(() => ({}));
    }catch(e){
      throw new Error("Network error. Check API/CORS or connection.");
    }
    if (!res.ok || data.ok === false){
      throw new Error(data.error || "Incorrect email or password.");
    }
    return data;
  }
  function rememberLogin(email, serverData){
    try{
      localStorage.setItem("realtysass.loginEmail", email);
      const existing = JSON.parse(localStorage.getItem("realtysass.identity") || "{}") || {};
      existing.email = email;
      const profile = (serverData && (serverData.profile || serverData.user || {})) || {};
      if (profile.full_name && !existing.name) existing.name = profile.full_name;
      localStorage.setItem("realtysass.identity", JSON.stringify(existing));
    }catch(e){}
  }
  async function onLogin(){
    const em = (emailInp.value || "").trim().toLowerCase();
    const pw = (passInp.value || "").trim();
    if (!em) return showMsg("Please enter your email.", true);
    if (pw.length < 8) return showMsg("Password must be at least 8 characters.", true);
    loginBtn.disabled = true;
    showMsg("Checking credentials...");
    try{
      const data = await loginWithServer(em, pw);
      rememberLogin(em, data);
      showMsg("");
      unlock();
    }catch(err){
      showMsg(err.message || "Incorrect email or password.", true);
      if (card && card.animate){
        card.animate(
          [{ transform:"translateX(-5px)" }, { transform:"translateX(5px)" }, { transform:"translateX(0)" }],
          { duration:260 }
        );
      }
      console.warn("[PCS LOCK] Login failed:", err && err.message);
    }finally{
      loginBtn.disabled = false;
    }
  }
  loginBtn.addEventListener("click", onLogin);
  passInp.addEventListener("keydown", (e)=>{ if (e.key === "Enter") onLogin(); });
  setTimeout(()=> emailInp && emailInp.focus(), 0);
})();
</script>
  </div>
  <div class="code-embed-17 w-embed w-script"><!--  =========================================================
Fiduciary Snapshot ‚Äî v3.9.5 (SPLIT EMBEDS)
EMBED #1 = SHELL ONLY (HTML + CSS)
‚úÖ KEEP SAME AS YOUR WORKING VERSION
‚úÖ UPDATE (Requested):
- Add a FULL Rent vs Buy section (canvas id="fid-line")
- Add footer metric IDs (rvb-gain / rvb-break / rvb-rentCost) so JS can populate like your screenshot
- Everything else unchanged
- Keeps hidden #fid-export so existing JS won‚Äôt crash
=========================================================  -->
    <section id="fid-fullscreen-shell" style="all: initial;">
      <!--  //#1 Chart.js CDN (must load BEFORE EMBED #2 runs)  -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
      <!--  //#2 CORE STYLES  -->
      <style>
    :root{
      --bg:#0f1220;
      --panel:#15192b;
      --card:#181b2e;
      --ink:#fff;
      --subink:#bdb5b5;
      --accent:#6aa7ff;
      --accent2:#8ef3c5;
      --ok:#55d399;
      --warn:#f9c74f;
      --bad:#ff6b6b;
      --kpiEdge: rgba(255,255,255,.06);
      --kpiBg: #12162b;
      --kpiBg2:#0f1326;
    }
    /* ============================================================
       //#2.0 SAFE PAGE RESET (does NOT kill scroll)
    ============================================================ */
    html, body{
      margin:0 !important;
      padding:0 !important;
      width:100% !important;
      background: var(--bg) !important;
      overflow-x:hidden !important;
      overflow-y:auto !important;
    }
    /* Global reset just for this widget */
    #fid-fullscreen-shell,
    #fid-fullscreen-shell * {
      box-sizing: border-box;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    /* ============================================================
       //#2.1 FULL-BLEED BREAKOUT (critical)
    ============================================================ */
    #fid-fullscreen-shell{
      display:block;
      position:relative;
      width:100vw;
      max-width:100vw;
      left:50%;
      right:50%;
      margin-left:-50vw;
      margin-right:-50vw;
      min-height:100vh;
      height:auto;
      padding:0;
      margin-top:0;
      overflow:visible;
      overflow-x:hidden;
      background:
        radial-gradient(1200px 800px at 18% 10%, rgba(106,167,255,.16), transparent 55%),
        radial-gradient(900px 700px at 72% 18%, rgba(142,243,197,.12), transparent 55%),
        radial-gradient(circle at top, #121726 0%, #0b0e1a 70%);
      color: var(--ink);
      isolation:isolate;
    }
    #fid-snapshot-shell {
      width:100%;
      max-width:100vw;
      min-width:0;
      margin:0;
      padding:0;
    }
    #fid-snapshot{
      display:block !important;
      width:100% !important;
    }
    #fid-card{
      width:100%;
      min-height:100vh;
      background: var(--card);
      border:0;
      border-radius:0;
      box-shadow:none;
      padding:18px;
      position:relative;
      color:var(--ink);
    }
    /* ‚úÖ Hidden ghost elements so Embed #2A doesn‚Äôt error on missing IDs */
    .fid-hiddenGhost{
      position:absolute !important;
      width:1px !important;
      height:1px !important;
      overflow:hidden !important;
      clip:rect(0 0 0 0) !important;
      clip-path: inset(50%) !important;
      white-space:nowrap !important;
      border:0 !important;
      padding:0 !important;
      margin:-1px !important;
      opacity:0 !important;
      pointer-events:none !important;
    }
    /* ============================================================
      //#2.15 BLUF TOP STRIP (SCOPED, NO GLOBAL :root OVERRIDE)
    ============================================================ */
    #ec-topbar, #ec-topbar *{
      box-sizing:border-box;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    #ec-topbar{
      --ec-ink:#fff;
      --ec-accent:#8ef3c5;
      --ec-accent2:#6aa7ff;
      --ec-blufH:74px;
    }
    #ec-blufHeader{
      position:sticky;
      top:0;
      z-index:50;
      height:var(--ec-blufH);
      display:flex;
      align-items:center;
      gap:14px;
      padding:12px 16px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(900px 220px at 70% 50%, rgba(142,243,197,.12), transparent 60%),
        radial-gradient(900px 220px at 30% 50%, rgba(106,167,255,.14), transparent 60%),
        rgba(0,0,0,.22);
      backdrop-filter: blur(14px);
      box-shadow:0 16px 32px rgba(0,0,0,.45);
    }
    #ec-blufCapsule{
      flex:1;
      min-width:0;
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.14);
      box-shadow:0 10px 22px rgba(0,0,0,.28);
      overflow:hidden;
    }
    #ec-blufTag{
      flex:0 0 auto;
      font-size:10px;
      font-weight:950;
      letter-spacing:.14em;
      text-transform:uppercase;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);
    }
    #ec-blufText{
      min-width:0;
      font-size:12.8px;
      font-weight:850;
      color:rgba(255,255,255,.90);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #ec-aiBtn{
      flex:0 0 auto;
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:rgba(255,255,255,.92);
      font-size:11px;
      font-weight:950;
      letter-spacing:.12em;
      text-transform:uppercase;
      text-decoration:none;
      white-space:nowrap;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      transition:.18s ease;
      user-select:none;
    }
    #ec-aiBtn:hover{ transform:translateY(-1px); filter:brightness(1.10); }
    #ec-aiBtn:active{ transform:translateY(0px); filter:brightness(1.00); }
    #ec-aiDot{
      width:9px; height:9px; border-radius:99px;
      background: radial-gradient(circle at top left, var(--ec-accent), var(--ec-accent2));
      box-shadow:0 0 0 4px rgba(106,167,255,.10);
      flex:0 0 auto;
    }
    /* KPI strip (5 cards) */
    .kpi-strip{
      display:grid;
      grid-template-columns:repeat(5,minmax(0,1fr));
      gap:18px;
      margin-top:14px;
    }
    @media (max-width:1280px){
      .kpi-strip{ grid-template-columns:repeat(3,minmax(0,1fr)); }
    }
    @media (max-width:760px){
      .kpi-strip{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
    @media (max-width:520px){
      .kpi-strip{ grid-template-columns:1fr; }
    }
    .kpi-card{
      position:relative;
      background:var(--kpiBg);
      border:1px solid var(--kpiEdge);
      border-radius:14px;
      padding:14px;
      min-height:86px;
      color:var(--ink);
      box-shadow:0 16px 32px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .kpi-title{
      font-size:12px;
      color:var(--subink);
      letter-spacing:.2px;
      text-transform:uppercase;
      font-weight:600;
      padding-right:88px;
    }
    .kpi-val{
      margin-top:8px;
      font-weight:700;
      font-size:20px;
      display:flex;
      align-items:center;
      gap:8px;
      color:#bdb5b5;
      line-height:1.2;
    }
    .delta{
      font-size:11px;
      margin-left:8px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(85,211,153,.10);
      color:var(--ok);
      line-height:1.2;
    }
    .kpi-actions{
      position:absolute;
      top:10px;
      right:10px;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:5;
    }
    .kpi-ico{
      width:30px; height:30px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.85);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      transition:.15s ease;
      font-size:14px;
      line-height:1;
    }
    .kpi-ico:hover{ transform:translateY(-1px); filter:brightness(1.08); }
    .kpi-btnMini{
      height:30px;
      padding:0 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.86);
      font-size:11px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
      user-select:none;
      transition:.15s ease;
    }
    .kpi-btnMini:hover{ transform:translateY(-1px); filter:brightness(1.08); }
    .kpi-btnMini.save{
      border:none;
      background:linear-gradient(90deg,var(--accent2),var(--accent));
      color:#07101b;
    }
    .kpi-editor{
      margin-top:10px;
      display:none;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .kpi-card.is-editing .kpi-editor{ display:grid; }
    .kpi-input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:var(--kpiBg2);
      color:#fff;
      outline:none;
      font-size:13px;
    }
    .kpi-hint{
      margin-top:8px;
      font-size:11px;
      color:rgba(255,255,255,.60);
      line-height:1.35;
      display:none;
    }
    .kpi-card.is-editing .kpi-hint{ display:block; }
    .score-bar{
      position:relative;
      width:100%;
      height:10px;
      border-radius:999px;
      background:linear-gradient(90deg,#ff6b6b,#f9c74f,#55d399);
      margin-top:8px;
      overflow:hidden;
    }
    .score-marker{
      position:absolute;
      top:-3px;
      width:2px;
      height:16px;
      background:#fff;
      border-radius:2px;
      left:0%;
      box-shadow:0 0 6px rgba(255,255,255,.6);
      pointer-events:none;
      z-index:3;
    }
    .score-slider{
      position:absolute;
      inset:-10px 0 -10px 0;
      width:100%;
      opacity:0;
      cursor:ew-resize;
      z-index:2;
    }
    .score-slider:focus{ outline:none; }
    /* ============================================================
      //#2.2 MID ROW LAYOUT (3 COLUMNS)
    ============================================================ */
    .mid{
      display:grid;
      grid-template-columns: 480px 1fr 360px;
      gap:18px;
      margin-top:18px;
      align-items:stretch;
    }
    @media (max-width:1280px){
      .mid{ grid-template-columns:1fr; }
    }
    .card-mini{
      background:#12162b;
      border:1px solid rgba(255,255,255,.06);
      border-radius:16px;
      padding:16px;
      display:flex;
      flex-direction:column;
      color:var(--ink);
      box-shadow:0 16px 32px rgba(0,0,0,.6);
      min-width:0;
    }
    .card-mini h3{
      margin:0 0 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .card-mini h3 span:first-child{
      font-size:14px;
      color:var(--subink);
      font-weight:700;
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .card-mini h3 span:last-child{
      font-size:11px;
      font-weight:400;
      text-transform:none;
      color:var(--subink);
      line-height:1.4;
      letter-spacing:0;
    }
    .chart-holder{
      position:relative;
      height: clamp(220px, 36vh, 420px);
      width:100%;
      display:block;
      overflow:hidden;
      border-radius:12px;
      background:#0f1220;
      border:1px solid rgba(255,255,255,.05);
      box-shadow:0 24px 48px rgba(0,0,0,.8) inset;
      min-width:0;
    }
    .chart-holder.rvb{
      height: clamp(260px, 44vh, 520px);
    }
    canvas{
      width:100% !important;
      height:100% !important;
      display:block;
    }
    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin:4px 0 10px;
      flex-wrap:wrap;
    }
    .select{
      background:#0f1326;
      color:#fff;
      border:1px solid rgba(255,255,255,.10);
      border-radius:10px;
      padding:8px 10px;
      font-size:12px;
    }
    .toggle{
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:#0f1326;
      font-size:12px;
      color:#fff;
      line-height:1.2;
    }
    .toggle[aria-pressed="true"]{
      background:#192041;
      border-color:rgba(255,255,255,.22);
    }
    .muted{ color:var(--subink); font-size:12px; line-height:1.4; }
    /* FEASIBILITY SNAPSHOT */
    .fs-wrap{
      background:rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px;
      box-shadow:0 14px 30px rgba(0,0,0,.45) inset;
    }
    /* ‚úÖ PCSUnited-style simple rows */
    .fs-simple{ display:flex; flex-direction:column; margin-bottom:10px; }
    .fs-line{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
      padding:10px 2px;
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .fs-line:last-child{ border-bottom:none; }
    .fs-left .lbl{
      font-size:11px;
      color:rgba(255,255,255,.62);
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:900;
    }
    .fs-left .sub{
      margin-top:4px;
      font-size:11px;
      color:rgba(255,255,255,.52);
      line-height:1.25;
    }
    .fs-right{
      font-size:18px;
      font-weight:950;
      color:#fff;
      white-space:nowrap;
      text-align:right;
    }
    .fs-bars{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .fs-row{ display:grid; grid-template-columns: 110px 1fr 90px; gap:10px; align-items:center; }
    .fs-row .name{
      font-size:11px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(255,255,255,.65);
      white-space:nowrap;
    }
    .fs-row .amt{ font-size:12px; font-weight:900; text-align:right; color:#fff; white-space:nowrap; }
    .fs-track{
      height:10px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden; position:relative;
    }
    .fs-fill{ height:100%; width:0%; border-radius:999px; box-shadow:0 0 18px rgba(0,0,0,.35) inset; }
    .fs-fill.expenses{ background: linear-gradient(90deg, rgba(106,167,255,.95), rgba(106,167,255,.35)); }
    .fs-fill.housing{  background: linear-gradient(90deg, rgba(85,211,153,.95), rgba(85,211,153,.35)); }
    .fs-fill.saving{   background: linear-gradient(90deg, rgba(142,243,197,.95), rgba(142,243,197,.35)); }
    .fs-fill.residual{ background: linear-gradient(90deg, rgba(249,199,79,.95), rgba(249,199,79,.35)); }
    .fs-fill.negative{ background: linear-gradient(90deg, rgba(255,107,107,.95), rgba(255,107,107,.35)); }
    .fs-foot{ margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end; gap:10px; flex-wrap:wrap; }
    .fs-res{ display:flex; flex-direction:column; gap:3px; }
    .fs-res .lbl{ font-size:10px; color:rgba(255,255,255,.58); letter-spacing:.12em; text-transform:uppercase; font-weight:900; }
    .fs-res .val{ font-size:20px; font-weight:950; line-height:1.1; color:#fff; }
    .fs-note{ font-size:11px; color:rgba(255,255,255,.58); max-width:260px; line-height:1.35; }
    /* CITY TARGETS */
    .city-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom:10px; }
    .city-kicker{ display:flex; gap:10px; align-items:flex-start; }
    .city-bed{
      font-size:34px; font-weight:900; line-height:1; color:var(--accent2);
      text-shadow:0 0 18px rgba(142,243,197,.25);
    }
    .city-bed small{
      display:block; font-size:12px; font-weight:800; color:var(--subink);
      letter-spacing:.12em; text-transform:uppercase; margin-top:6px;
    }
    .city-copy{ font-size:12px; color:rgba(255,255,255,.62); line-height:1.35; max-width:240px; }
    .city-hero{
      width:110px; height:76px; border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(60px 60px at 68% 30%, rgba(142,243,197,.28), transparent 60%),
        radial-gradient(70px 70px at 30% 70%, rgba(106,167,255,.24), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.10));
      position:relative; overflow:hidden; box-shadow:0 18px 40px rgba(0,0,0,.55); flex:0 0 auto;
    }
    .city-hero:after{
      content:"üè°"; position:absolute; right:10px; bottom:8px; font-size:34px;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.55)); opacity:.92;
    }
    /* ‚úÖ PCSUnited-style simple rows for city */
    .city-simple{ margin-top:10px; display:flex; flex-direction:column; }
    .city-line{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:center;
      padding:10px 2px;
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .city-line:last-child{ border-bottom:none; }
    .city-left .lbl{
      font-size:11px;
      color:rgba(255,255,255,.58);
      letter-spacing:.12em;
      text-transform:uppercase;
      font-weight:800;
    }
    .city-left .sub{
      margin-top:5px;
      font-size:11px;
      color:rgba(255,255,255,.54);
      line-height:1.3;
      max-width:260px;
    }
    .city-right{
      font-size:18px;
      font-weight:950;
      color:#fff;
      white-space:nowrap;
      text-align:right;
    }
    .gap-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      font-size:11px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      margin-top:8px;
    }
    .gap-pill.good{ color: var(--ok); }
    .gap-pill.bad{  color: var(--bad); }
    /* ============================================================
       ‚úÖ RENT vs BUY (Shell-only UI + IDs for JS to fill)
    ============================================================ */
    .rvb{
      margin-top:18px;
    }
    .rvb-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .rvb-title{
      font-size:14px;
      color:var(--subink);
      font-weight:800;
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .rvb-sub{
      font-size:11px;
      color:rgba(255,255,255,.58);
      line-height:1.35;
      max-width:520px;
    }
    .rvb-footer{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      font-size:12px;
      color:rgba(255,255,255,.62);
    }
    .rvb-metric{
      display:flex;
      align-items:baseline;
      gap:8px;
      white-space:nowrap;
    }
    .rvb-metric b{
      font-weight:950;
      color:#fff;
    }
    @media print{
      body, html{ background:#fff !important; }
    }
  </style>
      <!--  //#3 DASHBOARD BODY  -->
      <div id="fid-snapshot" data-summarize="https://theorozcorealty.netlify.app/.netlify/functions/summarize" style="all: initial;">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
        <div id="fid-snapshot-shell">
          <div id="fid-card">
            <!--  ‚úÖ Hidden ghost IDs: grade/meter + export kept but NEVER displayed  -->
            <div class="fid-hiddenGhost" aria-hidden="true">
              <span id="fid-dot"></span>
              <span id="fid-grade"></span>
              <span id="fid-disp"></span>
              <div id="fid-meter"></div>
              <button id="fid-export" type="button">Export ‚ñæ</button>
            </div>
            <!--  ============================================================
          //#0 BLUF STRIP (TOP)
        ============================================================  -->
            <div id="ec-topbar">
              <header id="ec-blufHeader" aria-label="BLUF Header">
                <div id="ec-blufCapsule" title="BLUF: deterministic verdict from your live dashboard numbers.">
                  <span id="ec-blufTag">BLUF</span>
                  <span id="ec-blufText">Loading verdict‚Ä¶</span>
                </div>
                <a id="ec-aiBtn" href="https://new-real-estate-purchase.webflow.io/features/fiduciary-memo" target="_self" rel="noopener" aria-label="Open A.I Analysis">
                  <span id="ec-aiDot"></span>
                  <span id="ec-aiText">A.I. ANALYSIS</span>
                </a>
              </header>
            </div>
            <div class="kpi-strip">
              <!--  KPI #1  -->
              <div class="kpi-card" id="kpi-income" data-kpi="income">
                <div class="kpi-actions" aria-label="income-actions">
                  <button class="kpi-ico" id="kpi-income-edit" type="button" title="Add additional income">‚úé</button>
                  <button class="kpi-btnMini save" id="kpi-income-save" type="button" style="display:none;">Save</button>
                  <button class="kpi-btnMini" id="kpi-income-cancel" type="button" style="display:none;">Cancel</button>
                </div>
                <div class="kpi-title">Total Monthly Income</div>
                <div class="kpi-val">
                  <span id="k-income">$0</span>
                  <span class="delta" id="k-inc-delta">+0%</span>
                </div>
                <div class="kpi-editor" id="kpi-income-editor">
                  <input class="kpi-input" id="in-addIncome" type="number" inputmode="numeric" min="0" step="50" placeholder="Additional income (monthly) e.g., 500">
                </div>
                <div class="kpi-hint">This adds on top of Total Monthly Income and updates the entire dashboard instantly.</div>
              </div>
              <!--  KPI #2  -->
              <div class="kpi-card" id="kpi-expense" data-kpi="expenses">
                <div class="kpi-actions" aria-label="expense-actions">
                  <button class="kpi-ico" id="kpi-expense-edit" type="button" title="Edit total monthly expense">‚úé</button>
                  <button class="kpi-btnMini save" id="kpi-expense-save" type="button" style="display:none;">Save</button>
                  <button class="kpi-btnMini" id="kpi-expense-cancel" type="button" style="display:none;">Cancel</button>
                </div>
                <div class="kpi-title">Total Monthly Expense</div>
                <div class="kpi-val">
                  <span id="k-expense">$0</span>
                  <span class="delta" id="k-exp-delta" style="background:rgba(255,107,107,.12); color:var(--bad);">+0%</span>
                </div>
                <div class="kpi-editor" id="kpi-expense-editor">
                  <input class="kpi-input" id="in-expensesOverride" type="number" inputmode="numeric" min="0" step="50" placeholder="Total monthly expense (e.g., 3550)">
                </div>
                <div class="kpi-hint">Use one clean number for the monthly total (charts adjust automatically).</div>
              </div>
              <!--  KPI #3  -->
              <div class="kpi-card" id="kpi-mtg" data-kpi="housing">
                <div class="kpi-actions" aria-label="mortgage-actions">
                  <button class="kpi-ico" id="kpi-mtg-edit" type="button" title="Edit housing cost">‚úé</button>
                  <button class="kpi-btnMini save" id="kpi-mtg-save" type="button" style="display:none;">Save</button>
                  <button class="kpi-btnMini" id="kpi-mtg-cancel" type="button" style="display:none;">Cancel</button>
                </div>
                <div class="kpi-title">Housing Cost</div>
                <div class="kpi-val" id="k-mtg">$0</div>
                <div class="kpi-editor" id="kpi-mtg-editor">
                  <input class="kpi-input" id="in-housingOverride" type="number" inputmode="numeric" min="0" step="25000" placeholder="confirm: housing input expects price-like values here">
                </div>
                <div class="kpi-hint">Use the arrows / scroll to adjust in $25,000 steps.</div>
              </div>
              <!--  KPI #4  -->
              <div class="kpi-card" id="kpi-save" data-kpi="savings">
                <div class="kpi-actions" aria-label="savings-actions">
                  <button class="kpi-ico" id="kpi-save-edit" type="button" title="Edit estimated downpayment">‚úé</button>
                  <button class="kpi-btnMini save" id="kpi-save-save" type="button" style="display:none;">Save</button>
                  <button class="kpi-btnMini" id="kpi-save-cancel" type="button" style="display:none;">Cancel</button>
                </div>
                <div class="kpi-title">Estimated Downpayment</div>
                <div class="kpi-val">
                  <span id="k-save">$0</span>
                  <span class="delta" id="k-sav-delta">+1.3%</span>
                </div>
                <div class="kpi-editor" id="kpi-save-editor">
                  <input class="kpi-input" id="in-savingsOverride" type="number" inputmode="numeric" min="0" step="100" placeholder="Estimated downpayment (e.g., 25000)">
                </div>
                <div class="kpi-hint">Defaults to 5% of Housing Cost unless you override it.</div>
              </div>
              <!--  KPI #5  -->
              <div class="kpi-card" id="kpi-score" data-kpi="creditScore">
                <div class="kpi-actions" aria-label="score-actions">
                  <button class="kpi-btnMini save" id="kpi-score-save" type="button" style="display:none;">Save</button>
                  <button class="kpi-btnMini" id="kpi-score-cancel" type="button" style="display:none;">Cancel</button>
                </div>
                <div class="kpi-title">
                  Credit Score <span id="score-band" style="margin-left:6px; font-weight:700;"></span>
                </div>
                <div class="kpi-val"><span id="k-score">‚Äî</span></div>
                <div class="score-bar" id="score-bar">
                  <div id="score-marker" class="score-marker"></div>
                  <input id="score-slider" class="score-slider" type="range" min="300" max="850" step="1" value="720" aria-label="Credit score slider">
                </div>
              </div>
            </div>
            <!--  MID ROW  -->
            <div class="mid">
              <!--  FEASIBILITY SNAPSHOT  -->
              <div class="card-mini" id="feasibility-card">
                <h3>
                  <span>FEASIBILITY SNAPSHOT</span>
                  <span>Income ‚Üí Housing + Expenses + Savings Target ‚Üí Residual</span>
                </h3>
                <div class="fs-wrap">
                  <!--  ‚úÖ SIMPLE WRITTEN ROWS  -->
                  <div class="fs-simple" aria-label="feasibility-top-rows">
                    <div class="fs-line">
                      <div class="fs-left">
                        <div class="lbl">Total Monthly Income</div>
                        <div class="sub" id="fs-income-sub">Total + Add‚Äôl</div>
                      </div>
                      <div class="fs-right" id="fs-income">$‚Äî</div>
                    </div>
                    <div class="fs-line">
                      <div class="fs-left">
                        <div class="lbl">All-in Housing</div>
                        <div class="sub" id="fs-housing-sub">Mortgage estimate / override</div>
                      </div>
                      <div class="fs-right" id="fs-housing">$‚Äî</div>
                    </div>
                    <div class="fs-line">
                      <div class="fs-left">
                        <div class="lbl">Monthly Expenses</div>
                        <div class="sub">Total monthly expense</div>
                      </div>
                      <div class="fs-right" id="fs-expenses">$‚Äî</div>
                    </div>
                    <div class="fs-line">
                      <div class="fs-left">
                        <div class="lbl">Savings Target</div>
                        <div class="sub" id="fs-saving-sub">% target from income</div>
                      </div>
                      <div class="fs-right" id="fs-saving">$‚Äî</div>
                    </div>
                  </div>
                  <div class="fs-bars" aria-label="feasibility-bars">
                    <div class="fs-row">
                      <div class="name">Expenses</div>
                      <div class="fs-track">
                        <div class="fs-fill expenses" id="fs-bar-exp"></div>
                      </div>
                      <div class="amt" id="fs-amt-exp">$‚Äî</div>
                    </div>
                    <div class="fs-row">
                      <div class="name">Housing</div>
                      <div class="fs-track">
                        <div class="fs-fill housing" id="fs-bar-hou"></div>
                      </div>
                      <div class="amt" id="fs-amt-hou">$‚Äî</div>
                    </div>
                    <div class="fs-row">
                      <div class="name">Savings</div>
                      <div class="fs-track">
                        <div class="fs-fill saving" id="fs-bar-sav"></div>
                      </div>
                      <div class="amt" id="fs-amt-sav">$‚Äî</div>
                    </div>
                    <div class="fs-row">
                      <div class="name">Residual</div>
                      <div class="fs-track">
                        <div class="fs-fill residual" id="fs-bar-res"></div>
                      </div>
                      <div class="amt" id="fs-amt-res">$‚Äî</div>
                    </div>
                  </div>
                  <div class="fs-foot">
                    <div class="fs-res">
                      <div class="lbl">Residual Income</div>
                      <div class="val" id="fs-residual">$‚Äî</div>
                    </div>
                    <div class="fs-note" id="fs-note">
                      Residual = Income ‚àí Expenses ‚àí Housing ‚àí Savings Target. This is the number that decides ‚Äútight vs breathable.‚Äù
                    </div>
                  </div>
                </div>
              </div>
              <!--  MONTHLY EXPENSES INTELLIGENCE  -->
              <div class="card-mini">
                <h3>
                  <span>MONTHLY EXPENSES INTELLIGENCE</span>
                  <span>This month by category / last months by trend</span>
                </h3>
                <div class="controls">
                  <button id="mode-abs" class="toggle" aria-pressed="true">$ Totals</button>
                  <button id="mode-pct" class="toggle" aria-pressed="false">% Composition</button>
                  <select id="exp-view" class="select">
                    <option value="monthly" selected="">Monthly</option>
                    <option value="yearly">Yearly</option>
                  </select>
                </div>
                <div class="chart-holder">
                  <canvas id="fid-bars"></canvas>
                </div>
                <div class="muted" style="margin-top:8px">
                  Monthly view shows categories for the active budget month.
                  Yearly view shows each saved month on the x-axis, stacked by category.
                  Toggle $ / % to switch measure.
                </div>
              </div>
              <!--  CITY TARGETS  -->
              <div class="card-mini" id="city-targets-card">
                <h3>
                  <span>CITY TARGETS</span>
                  <span id="ct-subtitle">Market fit: avg vs your target</span>
                </h3>
                <div class="city-top">
                  <div class="city-kicker">
                    <div class="city-bed">
                      <span id="ct-beds">4</span>
                      <small>BEDROOM</small>
                    </div>
                    <div class="city-copy" id="ct-copy">
                      Uses your income + credit assumptions to calculate a target home price, then compares it to the market average.
                    </div>
                  </div>
                  <div class="city-hero" aria-hidden="true"></div>
                </div>
                <!--  ‚úÖ SIMPLE WRITTEN ROWS  -->
                <div class="city-simple" aria-label="city-simple-rows">
                  <div class="city-line">
                    <div class="city-left">
                      <div class="lbl">Target Rent</div>
                      <div class="sub" id="ct-rent-sub">Uses BAH (brain.js) when available</div>
                    </div>
                    <div class="city-right"><span id="ct-rent">$‚Äî</span><span style="font-size:12px; font-weight:900; color:rgba(255,255,255,.65)"> / mo</span></div>
                  </div>
                  <div class="city-line">
                    <div class="city-left">
                      <div class="lbl">Average Home Price</div>
                      <div class="sub" id="ct-home-sub">From city market baseline</div>
                    </div>
                    <div class="city-right" id="ct-home">$‚Äî</div>
                  </div>
                  <div class="city-line">
                    <div class="city-left">
                      <div class="lbl">Target Home Price</div>
                      <div class="sub" id="ct-target-sub">Based on max housing ‚â§ 33% income</div>
                    </div>
                    <div class="city-right" id="ct-target-home">$‚Äî</div>
                  </div>
                  <div class="city-line">
                    <div class="city-left">
                      <div class="lbl">Market Gap</div>
                      <div class="sub" id="ct-gap-sub">Avg ‚àí Target (positive = market above target)</div>
                      <div class="gap-pill" id="ct-gap-pill">‚Äî</div>
                    </div>
                    <div class="city-right" id="ct-gap">$‚Äî</div>
                  </div>
                </div>
              </div>
            </div>
            <!--  ‚úÖ UPDATED: RENT VS BUY (full section + footer IDs)  -->
            <div class="card-mini rvb" id="rentbuy-card">
              <div class="rvb-top">
                <div>
                  <div class="rvb-title">RENT VS BUY ANALYSIS</div>
                  <div class="rvb-sub">
                    10-year net cost comparison. Buying cost reflects mortgage + taxes/insurance/HOA/PMI assumptions from your live scenario.
                  </div>
                </div>
                <div class="rvb-sub" style="text-align:right;">
                  Legend and values appear once your scenario loads.
                </div>
              </div>
              <div class="chart-holder rvb">
                <canvas id="fid-line"></canvas>
              </div>
              <div class="rvb-footer" aria-label="rent-vs-buy-footer">
                <div class="rvb-metric">Long-Term Gain: <b id="rvb-gain">‚Äî</b></div>
                <div class="rvb-metric">Break-even: <b id="rvb-break">‚Äî</b></div>
                <div class="rvb-metric">Cost of Renting: <b id="rvb-rentCost">‚Äî</b></div>
              </div>
              <div class="muted" style="margin-top:10px">
                Outputs are educational, not advice.
              </div>
            </div>
            <div class="muted" style="margin-top:12px">
              Outputs are educational, not financial advice.
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <div class="w-embed w-script">
    <script>
(() => {
  // ============================================================
  // RS_FID ‚Ä¢ CORE RUNTIME (must load FIRST)
  // Section A (2A): KPIs + Feasibility Snapshot + Shared state + brain fetch
  //
  // ‚úÖ FIX (DO NOT MOVE CHARTS / DO NOT CHANGE LAYOUT):
  // - Income prefers BRAIN TOTAL PAY (base+BAH+BAS+etc)
  // - Bridge income used ONLY if brain total missing
  //
  // ‚úÖ UPDATED:
  // - Mortgage Breakdown now uses /api/mortgage (mortgage.js) as source of truth:
  //   Principal ‚Ä¢ Interest ‚Ä¢ Taxes ‚Ä¢ Insurance ‚Ä¢ HOA
  // - Taxes/Insurance/HOA no longer stuck at $0 when brain lacks fields
  //
  // ‚úÖ UPDATED (Requested):
  // - Bottom "RESIDUAL INCOME" row becomes "MORTGAGE ESTIMATE" (All-In)
  //
  // ‚úÖ Bridge to BLUF:
  // - Publish Feasibility Snapshot ‚Üí localStorage: realtysass.feasibility.v1
  // - Mirror verdict ‚Üí localStorage: realtysass.ec_verdict.v1
  //
  // ‚úÖ Feasibility 4 tiles refresh (unchanged from your provided 2A):
  // - Tile #1 TOTAL MONTHLY INCOME
  // - Tile #2 TOTAL MONTHLY EXPENSES = Monthly Expenses + Estimated Mortgage
  // - Tile #3 DISPOSABLE INCOME = Income - Total Monthly Expenses
  // - Tile #4 FINANCIAL HEALTH = Grade (28% rule + disposable %)
  //
  // ‚úÖ PATCH (THIS REQUEST):
  // - Credit Score slider NOW updates Mortgage Estimate immediately (local calc),
  //   and then re-syncs to mortgage.js once the network response returns.
  //   (Prevents ‚Äústuck‚Äù estimate due to async timing / stale breakdown.)
  // - Taxes / Insurance / HOA now default from brain.city rates (if bridge doesn‚Äôt supply them)
  // - If mortgage endpoint returns no breakdown, we still compute Tax/Ins/HOA monthly from city rates
  // - Monthly Expenses fallback: if bridge.expenses is missing, sum bridge.itemizedRows monthly
  //
  // ‚úÖ NEW (Needed fix only):
  // - ONLY trust mortgage.js breakdown when it matches the CURRENT mortgage request key.
  //   If mortgage.js response doesn't echo inputs (common), old breakdown could be reused and look "stuck".
  //   We now stamp each mortgage response with __key and require __key === current key.
  // ============================================================
  if (window.RS_FID && window.RS_FID.__coreMounted) return;
  const CORE = (window.RS_FID = window.RS_FID || {});
  CORE.__coreMounted = true;
  const $ = (q) => document.querySelector(q);
  // ---------- Ready helper ----------
  function onReady(fn){
    if (document.readyState === "complete" || document.readyState === "interactive") {
      setTimeout(fn, 0);
    } else {
      document.addEventListener("DOMContentLoaded", fn, { once:true });
    }
  }
  // ---------- Format helpers ----------
  const cur = (n, d=0) => (Number(n)||0).toLocaleString("en-US", {
    style:"currency", currency:"USD",
    minimumFractionDigits:d, maximumFractionDigits:d
  });
  const signed = (n) => (n>=0 ? cur(n,0) : ("-"+cur(Math.abs(n),0)));
  // ---------- Small numeric helper ----------
  function n0(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }
  // ---------- Math ----------
  function pmti(P,r,n){
    P = n0(P);
    if (P<=0) return 0;
    if (r===0) return P/Math.max(1,n);
    const x = Math.pow(1+r,n);
    return P*(r*x)/(x-1);
  }
  function scoreAPR(s){
    s=Number(s)||720;
    if(s>=780) return 6.50;
    if(s>=760) return 6.75;
    if(s>=720) return 7.00;
    if(s>=700) return 7.20;
    if(s>=680) return 7.35;
    if(s>=660) return 7.85;
    if(s>=640) return 8.25;
    if(s>=620) return 9.25;
    return 9.95;
  }
  function bandFromScore(s){
    if(s>=760) return "Excellent";
    if(s>=720) return "Good";
    if(s>=680) return "Fair";
    if(s>=640) return "OK-ish";
    if(s>=620) return "Weak";
    return "Subprime";
  }
  // ---------- Brain API origin fix ----------
  const RS_LIVE_API_ORIGIN = "https://theorozcorealty.netlify.app";
  const RS_API_ORIGIN = (() => {
    const host = String(location.hostname || "").toLowerCase();
    if (host.endsWith(".webflow.io")) return RS_LIVE_API_ORIGIN;
    return "";
  })();
  const rsApiUrl = (path) => {
    const base = (RS_API_ORIGIN || "");
    if (!base) return path;
    return base.replace(/\/+$/,"") + "/" + String(path||"").replace(/^\/+/,"");
  };
  // ---------- Email resolver ----------
  function resolveEmail(){
    const a = localStorage.getItem("realtysass.loginEmail");
    if (a) return a;
    try{
      const pl = JSON.parse(localStorage.getItem("realtysass.profile_lookup")||"{}");
      const b = pl?.profile?.email;
      if (b) return b;
    }catch(_){}
    return "orozco@me.com";
  }
  // ---------- pickFirst ----------
  function pickFirst(obj, keys){
    for (const k of keys){
      const v = obj?.[k];
      if (v !== undefined && v !== null && v !== "") return v;
    }
    return null;
  }
  // ---------- Bridge state ----------
  CORE.bridge = CORE.bridge || null;
  function loadBridge(){
    let bridge = null;
    try{
      const raw = localStorage.getItem("realtysass.bridge");
      if (raw) bridge = JSON.parse(raw);
    }catch(_){}
    if (!bridge && location.hash){
      const m = location.hash.match(/(?:^|#|&)rsb=([A-Za-z0-9\-_]+)/);
      if (m){
        try{
          const json = decodeURIComponent(escape(atob(m[1].replace(/-/g,"+").replace(/_/g,"/"))));
          bridge = JSON.parse(json);
        }catch(_){}
      }
    }
    // optional expense rows fallback
    try{
      if(!bridge?.itemizedRows){
        const rows = JSON.parse(localStorage.getItem("va.expenses.rows")||"[]");
        if(rows?.length){
          bridge = Object.assign({}, bridge, {
            itemizedRows: rows.map(r=>({ name:r.name, monthly:r.month, cat:r.cat }))
          });
        }
      }
    }catch(_){}
    CORE.bridge = bridge;
  }
  // listen for bridge messages
  window.addEventListener("message", (ev)=>{
    try{
      const msg = ev.data || {};
      if (msg.type==="realtysass-bridge" && msg.payload){
        CORE.bridge = msg.payload;
        CORE.state.rentStartOverride = null;
        // ‚úÖ Chain so brain loads before mortgage tries to use city rates
        Promise.resolve()
          .then(()=>CORE.fetchBrain?.())
          .then(()=>CORE.fetchMortgage?.())
          .then(()=>CORE.paintAll())
          .catch(()=>CORE.paintAll());
      }
    }catch(_){}
  }, false);
  // ============================================================
  // ‚úÖ KPI Overrides (Back-compat with your Shell + older saves)
  // ============================================================
  const OV_KEY = "realtysass.kpi_overrides.v1";
  function readOverrides(){
    try{ return JSON.parse(localStorage.getItem(OV_KEY)||"{}")||{}; }
    catch(_){ return {}; }
  }
  function writeOverrides(obj){
    try{ localStorage.setItem(OV_KEY, JSON.stringify(obj||{})); }
    catch(_){ }
  }
  function numOrNull(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }
  function getOv(){
    const o = readOverrides();
    const addIncome = Math.max(0, Number(
      pickFirst(o, ["addIncome","add_income","addIncomeOverride","incomeAdd","additionalIncome"]) || 0
    ) || 0);
    const expenses = numOrNull(pickFirst(o, ["expensesOverride","expenses","monthlyExpenses","expenseOverride"]));
    const housing  = numOrNull(pickFirst(o, ["housingOverride","housing","homePrice","priceOverride"]));
    const savings  = numOrNull(pickFirst(o, ["savingsOverride","savings","downpayment","dpAmt","downPaymentAmt"]));
    const creditScore = numOrNull(pickFirst(o, ["creditScore","score","fico","credit_score"]));
    return { addIncome, expenses, housing, savings, creditScore };
  }
  CORE.getOv = getOv;
  CORE.readOverrides = readOverrides;
  CORE.writeOverrides = writeOverrides;
  // ============================================================
  // ‚úÖ BRAIN FETCH (cached)
  // ============================================================
  const BRAIN_KEY = "realtysass.brain_cache.v1";
  CORE.brain = CORE.brain || null;
  function buildBrainPayload(){
    const email = resolveEmail();
    const b = CORE.bridge || {};
    const ov = getOv();
    const price =
      (ov.housing != null ? n0(ov.housing) : n0(b.housing || b.price || b.homePrice || b.purchasePrice || 0));
    const dpAmt =
      n0(b.dpAmt || b.downPayment || b.downPaymentAmt || b.down_payment || 0) ||
      n0(ov.savings != null ? ov.savings : b.savings);
    const dpPct =
      n0(b.dpPct || b.downPaymentPct || b.down_payment_pct || 0) ||
      (price>0 && dpAmt>0 ? ((dpAmt/price)*100) : 0);
    const creditScore =
      (ov.creditScore != null ? ov.creditScore : (b.creditScore || b.credit_score || null));
    const termYears = n0(b.termYears || b.term || b.term_years || 30) || 30;
    const cityKey = b.cityKey || b.city || "SanAntonio";
    const bedrooms = n0(b.bedrooms || 4) || 4;
    return {
      email,
      cityKey,
      bedrooms,
      price: price>0 ? price : undefined,
      dpPct: dpPct>0 ? dpPct : undefined,
      termYears,
      creditScore: creditScore != null ? Number(creditScore) : undefined
    };
  }
  CORE.fetchBrain = async function fetchBrain(){
    const payload = buildBrainPayload();
    try{
      const r = await fetch(rsApiUrl("/api/brain"),{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (j && (j.ok || j.schemaVersion)){
        CORE.brain = j;
        try{ localStorage.setItem(BRAIN_KEY, JSON.stringify({ t:Date.now(), data:j })); }catch(_){}
        return j;
      }
    }catch(_){}
    // fallback cache
    try{
      const c = JSON.parse(localStorage.getItem(BRAIN_KEY)||"{}");
      if (c?.data){
        CORE.brain = c.data;
        return CORE.brain;
      }
    }catch(_){}
    return null;
  };
  // ============================================================
  // ‚úÖ CITY RATE EXTRACTION (from brain.city JSON)
  // ============================================================
  function extractCityFromBrain(brain){
    if (!brain) return null;
    const city =
      brain.city ||
      brain.cityData ||
      brain.market?.city ||
      brain.data?.city ||
      brain.payload?.city ||
      null;
    return (city && typeof city === "object") ? city : null;
  }
  function toFractionFromMaybePercent(x){
    const v = Number(x);
    if (!Number.isFinite(v) || v < 0) return null;
    if (v > 0.25) return v / 100; // likely percent like 1.12
    return v; // already a fraction like 0.0112
  }
  function cityRatesForPrice(price){
    const city = extractCityFromBrain(CORE.brain) || {};
    const taxRaw = pickFirst(city, ["property_tax_rate","propertyTaxRate","tax_rate","taxRate"]);
    const insRaw = pickFirst(city, ["insurance_rate","insuranceRate"]);
    const hoaRaw = pickFirst(city, ["hoa_monthly","hoaMonthly","hoa_mo"]);
    const taxRateFrac = toFractionFromMaybePercent(taxRaw);
    const insRateFrac = toFractionFromMaybePercent(insRaw);
    const hoaMonthly  = Number.isFinite(Number(hoaRaw)) ? Math.max(0, Number(hoaRaw)) : null;
    const insuranceAnnual =
      (insRateFrac != null && price > 0)
        ? (price * insRateFrac)
        : null;
    return { taxRateFrac, insuranceAnnual, hoaMonthly, __city: city };
  }
  // ============================================================
  // ‚úÖ MORTGAGE FETCH (mortgage.js) ‚Äî deterministic breakdown
  // ============================================================
  const MORT_KEY = "realtysass.mortgage_cache.v1";
  CORE.mortgage = CORE.mortgage || null;
  CORE.__mortKey = CORE.__mortKey || "";
  CORE.__mortSeq = CORE.__mortSeq || 0; // ‚úÖ request sequencing to avoid stale paints
  function buildMortgagePayload(){
    const b = CORE.bridge || {};
    const ov = getOv();
    const price =
      (ov.housing != null ? n0(ov.housing) : n0(b.housing || b.price || b.homePrice || b.purchasePrice || 0));
    const down =
      n0(b.dpAmt || b.downPayment || b.downPaymentAmt || b.down_payment || 0) ||
      n0(ov.savings != null ? ov.savings : b.savings);
    const creditScore =
      (ov.creditScore != null ? ov.creditScore : (Number(b.creditScore)||Number(b.credit_score)||NaN));
    const termYears = n0(b.termYears || b.term || b.term_years || 30) || 30;
    const loanType = String(pickFirst(b, ["loanType","loan_type"]) || "conventional");
    // Optional passthroughs if you ever add them to bridge
    const taxRateFromBridge = numOrNull(pickFirst(b, ["taxRate","tax_rate"]));               // fraction like 0.021
    const taxAnnualFromBridge = numOrNull(pickFirst(b, ["taxAnnual","tax_annual"]));
    const insuranceAnnualFromBridge = numOrNull(pickFirst(b, ["insuranceAnnual","insAnnual"]));
    const hoaMonthlyFromBridge = numOrNull(pickFirst(b, ["hoaMonthly","hoaMo","hoa"]));
    // ‚úÖ City defaults (only used if bridge doesn‚Äôt supply)
    const rates = cityRatesForPrice(price);
    // Allow explicit APR override if you pass it (otherwise mortgage.js uses its own tiers)
    const aprOverride = numOrNull(pickFirst(b, ["aprOverride","apr_override","apr"]));
    return {
      price: price>0 ? price : 0,
      down: down>0 ? down : 0,
      creditScore: Number.isFinite(Number(creditScore)) ? Number(creditScore) : undefined,
      termYears,
      loanType,
      // ‚úÖ Defaults: bridge > city
      taxRate: (taxRateFromBridge != null ? taxRateFromBridge : (rates.taxRateFrac != null ? rates.taxRateFrac : undefined)),
      taxAnnual: (taxAnnualFromBridge != null ? taxAnnualFromBridge : undefined),
      insuranceAnnual: (insuranceAnnualFromBridge != null ? insuranceAnnualFromBridge : (rates.insuranceAnnual != null ? rates.insuranceAnnual : undefined)),
      hoaMonthly: (hoaMonthlyFromBridge != null ? hoaMonthlyFromBridge : (rates.hoaMonthly != null ? rates.hoaMonthly : undefined)),
      aprOverride: (aprOverride != null && aprOverride > 0 ? aprOverride : undefined)
    };
  }
  function mortKeyFromPayload(p){
    // stable cache key so we don't spam Netlify
    return [
      "p", Math.round(n0(p.price)),
      "d", Math.round(n0(p.down)),
      "s", Math.round(n0(p.creditScore)),
      "t", Math.round(n0(p.termYears)),
      "lt", String(p.loanType||"").toLowerCase(),
      "tr", (p.taxRate!=null ? String(p.taxRate) : ""),
      "ta", (p.taxAnnual!=null ? String(p.taxAnnual) : ""),
      "ia", (p.insuranceAnnual!=null ? String(p.insuranceAnnual) : ""),
      "hm", (p.hoaMonthly!=null ? String(p.hoaMonthly) : ""),
      "ao", (p.aprOverride!=null ? String(p.aprOverride) : "")
    ].join("|");
  }
  CORE.fetchMortgage = async function fetchMortgage(){
    const payload = buildMortgagePayload();
    if (!payload.price || payload.price <= 0) return null;
    const key = mortKeyFromPayload(payload);
    if (key === CORE.__mortKey && CORE.mortgage?.ok) return CORE.mortgage;
    CORE.__mortKey = key;
    const mySeq = ++CORE.__mortSeq;
    // Try live
    try{
      const r = await fetch(rsApiUrl("/api/mortgage"),{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (j && j.ok){
        // ‚úÖ only accept if still the latest request
        if (mySeq === CORE.__mortSeq){
          // ‚úÖ PATCH: stamp response with key so snapshot can verify it matches CURRENT inputs
          try{ j.__key = key; }catch(_){}
          CORE.mortgage = j;
          try{ localStorage.setItem(MORT_KEY, JSON.stringify({ t:Date.now(), key, data:j })); }catch(_){}
        }
        return j;
      }
    }catch(_){}
    // Cache fallback (only if same key)
    try{
      const c = JSON.parse(localStorage.getItem(MORT_KEY)||"{}");
      if (c?.data && c?.key === key){
        if (mySeq === CORE.__mortSeq){
          // ‚úÖ PATCH: stamp cached response too
          try{ c.data.__key = key; }catch(_){}
          CORE.mortgage = c.data;
        }
        return c.data;
      }
    }catch(_){}
    return null;
  };
  // ============================================================
  // ‚úÖ PAY PICKER (BRAIN TOTAL PAY > BRIDGE INCOME)
  // ============================================================
  function extractBrainPay(brain){
    const pay = brain?.pay || brain || {};
    const base =
      Number(pickFirst(pay, ["basePay","base_pay","base"]) || 0) ||
      Number(pickFirst(brain, ["basePay","base_pay","base"]) || 0) || 0;
    const bah =
      Number(pickFirst(pay, ["bah","BAH","bahMonthly","bah_monthly"]) || 0) ||
      Number(pickFirst(brain, ["bah","BAH"]) || 0) || 0;
    const bas =
      Number(pickFirst(pay, ["bas","BAS","basMonthly","bas_monthly"]) || 0) ||
      Number(pickFirst(brain, ["bas","BAS"]) || 0) || 0;
    const disability =
      Number(pickFirst(pay, ["disability","vaDisabilityPay","vaDisabilityMonthly","va_disability_monthly","disabilityMonthly"]) || 0) ||
      Number(pickFirst(brain, ["disability","vaDisabilityPay","vaDisabilityMonthly","va_disability_monthly","disabilityMonthly"]) || 0) || 0;
    const totalExplicit =
      Number(pickFirst(pay, ["total","totalPay","total_pay","totalComp","total_comp","totalMonthly","monthlyTotal","monthly_total"]) || 0) ||
      Number(pickFirst(brain, ["total","totalPay","total_pay","totalComp","total_comp","totalMonthly","monthlyTotal","monthly_total"]) || 0) || 0;
    const computed = (base + bah + bas + disability);
    const total = (totalExplicit > 0 ? totalExplicit : (computed > 0 ? computed : 0));
    return { total, base, bah, bas, disability, computed, totalExplicit };
  }
  // ‚úÖ Mortgage extractor from brain (kept as fallback)
  function extractBrainMortgage(brain){
    const candidates = [];
    candidates.push(n0(brain?.estimatedMonthlyMortgage));
    candidates.push(n0(brain?.estimated_monthly_mortgage));
    candidates.push(n0(brain?.monthlyMortgage));
    candidates.push(n0(brain?.monthly_mortgage));
    const m = brain?.mortgage || {};
    candidates.push(n0(m?.totalMonthly));
    candidates.push(n0(m?.total_monthly));
    candidates.push(n0(m?.monthlyTotal));
    candidates.push(n0(m?.monthly_total));
    candidates.push(n0(m?.principalInterest));
    candidates.push(n0(m?.principal_interest));
    candidates.push(n0(m?.pAndI));
    candidates.push(n0(m?.p_and_i));
    const best = candidates
      .map(v => Number(v)||0)
      .filter(v => v > 0)
      .sort((a,b)=>b-a)[0] || 0;
    return best;
  }
  // ‚úÖ local mortgage fallback (returns P&I + total)
  function computeMortgageMonthlyLocal({ price, dpAmt, creditScore, termYears, tihoa, pmi, aprOverride }){
    price = Math.max(0, n0(price));
    dpAmt = Math.max(0, n0(dpAmt));
    termYears = n0(termYears) || 30;
    const apr = (n0(aprOverride) > 0 ? n0(aprOverride) : scoreAPR(creditScore));
    const loan  = Math.max(0, price - dpAmt);
    const mRate = (apr/100)/12;
    const termN = Math.max(1, termYears*12);
    const pAndI = loan>0 ? pmti(loan, mRate, termN) : 0;
    const extra = Math.max(0, n0(tihoa)) + Math.max(0, n0(pmi));
    return { mortgageMonthly: (pAndI + extra), apr, pAndI, loan, termN, mRate };
  }
  // ============================================================
  // ‚úÖ Feasibility ‚Üí BLUF publisher (cross-page bridge)
  // ============================================================
  const FEAS_KEY = "realtysass.feasibility.v1";
  const VERDICT_KEY = "realtysass.ec_verdict.v1";
  function roundNice(n){ return Math.round(n); }
  function safeNum(n){ n = Number(n); return Number.isFinite(n) ? n : 0; }
  function buildFeasibilityVerdict(s){
    const income   = safeNum(s.income);
    const expenses = Math.max(0, safeNum(s.expenses));
    const housing  = Math.max(0, safeNum(s.mortgageMonthly));
    const capPct = 0.30;
    const housingCap = income * capPct;
    const residualIncome = safeNum(s.residualIncome);
    const disposable = safeNum(s.disposableAfterMortgage);
    let status = "GREEN";
    if (housing > housingCap) status = "NO-GO";
    else if (disposable < 0) status = "NO-GO";
    else if (disposable < income * 0.10) status = "CAUTION";
    const delta = housing - housingCap;
    let bluf = "";
    if (status === "NO-GO"){
      bluf = `NO-GO: Housing is ${cur(housing,0)}/mo vs a safe cap of ${cur(housingCap,0)}/mo. Reduce by ~${cur(Math.max(0, delta),0)}.`;
    } else if (status === "CAUTION"){
      bluf = `CAUTION: Housing is ${cur(housing,0)}/mo vs cap ${cur(housingCap,0)}/mo. Buffer is thin (Disposable ${cur(disposable,0)}/mo).`;
    } else {
      bluf = `GREEN: Housing is ${cur(housing,0)}/mo under cap ${cur(housingCap,0)}/mo. Disposable ${cur(disposable,0)}/mo.`;
    }
    return { status, bluf, income, expenses, housing, residualIncome, disposable, housingCap, capPct };
  }
  function publishFeasibility(s){
    try{
      const email = resolveEmail();
      const v = buildFeasibilityVerdict(s);
      const payload = {
        schema: "realtysass.feasibility.v1",
        ts: Date.now(),
        source: {
          page: location.pathname || "",
          href: String(location.href || ""),
          widget: "analyze-2A",
          version: "2A+publisher.v3(mortgage.js-breakdown+city-fallback)"
        },
        email,
        status: v.status,
        bluf: v.bluf,
        income: roundNice(v.income),
        expenses: roundNice(v.expenses),
        housing: roundNice(v.housing),
        housingCap: roundNice(v.housingCap),
        capPct: v.capPct,
        residualIncome: roundNice(v.residualIncome),
        disposable: roundNice(v.disposable),
        creditScore: roundNice(s.creditScore || 0),
        aprUsed: Number(s.aprUsed || 0),
        termYears: roundNice(s.termYears || 30),
        price: roundNice(s.price || 0),
        dpAmt: roundNice(s.dpAmt || 0),
        mort_principal: roundNice(s.principalMo || 0),
        mort_interest:  roundNice(s.interestMo || 0),
        mort_tax:       roundNice(s.taxMo || 0),
        mort_insurance: roundNice(s.insMo || 0),
        mort_hoa:       roundNice(s.hoaMo || 0)
      };
      localStorage.setItem(FEAS_KEY, JSON.stringify(payload));
      const compactVerdict = {
        ts: payload.ts,
        status: payload.status,
        bluf: payload.bluf,
        housing: payload.housing,
        housingCap: payload.housingCap,
        disposable: payload.disposable
      };
      localStorage.setItem(VERDICT_KEY, JSON.stringify(compactVerdict));
      try{
        if (window.parent && window.parent !== window){
          window.parent.postMessage({ type:"realtysass-feasibility", payload }, "*");
        }
      }catch(_){}
    }catch(_){}
  }
  // ============================================================
  // ‚úÖ Snapshot builder (now prefers mortgage.js breakdown)
  // ‚úÖ PATCH: instant credit-score responsiveness:
  //     If the cached mortgage.js response doesn‚Äôt match the CURRENT inputs,
  //     ignore it and use local calc until the fresh response lands.
  // ============================================================
  CORE.snapshotFromBridge = function snapshotFromBridge(){
    const b = CORE.bridge || {};
    const ov = getOv();
    const brain = CORE.brain;
    const bp = extractBrainPay(brain);
    // ‚úÖ Income priority
    const brainTotal = n0(bp.total);
    const bridgeIncome = n0(b.income);
    const brainBase = n0(bp.base);
    const baseIncome = (brainTotal > 0 ? brainTotal : (bridgeIncome > 0 ? bridgeIncome : brainBase));
    const income     = baseIncome + (ov.addIncome || 0);
    // ‚úÖ Monthly Expenses fallback:
    // - Use bridge.expenses if present
    // - Else sum itemizedRows (monthly) if available
    const expensesFromBridge = n0(b.expenses);
    const expensesFromRows = (() => {
      const rows = Array.isArray(b.itemizedRows) ? b.itemizedRows : [];
      if (!rows.length) return 0;
      let sum = 0;
      for (const r of rows){
        const m = n0(r?.monthly ?? r?.month ?? r?.mo ?? 0);
        sum += m;
      }
      return Math.max(0, sum);
    })();
    const expenses0 = (expensesFromBridge > 0 ? expensesFromBridge : (expensesFromRows > 0 ? expensesFromRows : 0));
    const expenses = (ov.expenses==null ? expenses0 : Math.max(0, ov.expenses));
    // Downpayment amount (KPI #4)
    const dpAmt =
      n0(b.dpAmt || b.downPayment || b.downPaymentAmt || b.down_payment || 0) ||
      n0(ov.savings != null ? ov.savings : b.savings);
    // Home price (KPI #3)
    const price =
      (ov.housing != null ? n0(ov.housing) : n0(b.housing || b.price || b.homePrice || b.purchasePrice || 0));
    const termYears = n0(b.termYears) || 30;
    const creditScore = (ov.creditScore==null
      ? (Number(b.creditScore)||720)
      : Math.max(300, Math.min(850, ov.creditScore)));
    const aprOverride = n0(pickFirst(b, ["aprOverride","apr_override","apr"]));
    // pull extras (if present)
    const pmi   = n0(b.pmi);
    // ‚úÖ City rate fallback (monthly)
    const rates = cityRatesForPrice(price);
    const taxMoLocal = (rates.taxRateFrac != null && price>0) ? ((price * rates.taxRateFrac)/12) : 0;
    const insMoLocal = (rates.insuranceAnnual != null) ? (rates.insuranceAnnual/12) : 0;
    const hoaMoLocal = (rates.hoaMonthly != null) ? rates.hoaMonthly : 0;
    // ‚úÖ Local calc uses TI+HOA if bridge didn‚Äôt pass tihoa
    const tihoaFromBridge = n0(b.tihoa);
    const tihoa = (tihoaFromBridge > 0 ? tihoaFromBridge : (taxMoLocal + insMoLocal + hoaMoLocal));
    // ‚úÖ Local calc (fallback for principal/interest math)
    const localM = computeMortgageMonthlyLocal({ price, dpAmt, creditScore, termYears, tihoa, pmi, aprOverride });
    // ‚úÖ Brain mortgage as fallback
    const brainMortgage = extractBrainMortgage(brain);
    // ‚úÖ Mortgage.js breakdown (preferred ONLY when it matches current key)
    const mjRaw = CORE.mortgage?.ok ? CORE.mortgage : null;
    // ‚úÖ PATCH: compute the CURRENT expected mortgage key and require mjRaw.__key === expectedKey
    let expectedKey = "";
    try{
      expectedKey = mortKeyFromPayload(buildMortgagePayload());
    }catch(_){ expectedKey = ""; }
    const mj = (mjRaw && mjRaw.__key && expectedKey && (mjRaw.__key === expectedKey)) ? mjRaw : null;
    const bj = mj?.breakdown || null;
    // 1) Determine All-in Mortgage Monthly
    let mortgageMonthly =
      (bj && n0(bj.allIn) > 0) ? n0(bj.allIn)
      : Math.max(0, brainMortgage, n0(localM.mortgageMonthly));
    // 2) Determine APR used (mortgage.js apr > override > local tier)
    const aprUsed =
      (mj && n0(mj.apr) > 0) ? n0(mj.apr)
      : (n0(aprOverride) > 0 ? n0(aprOverride) : scoreAPR(creditScore));
    // 3) Determine breakdown components (mortgage.js wins; else city fallback)
    const piCombined =
      (bj && n0(bj.pi) > 0) ? n0(bj.pi)
      : n0(localM.pAndI);
    let taxMo =
      (bj && (bj.tax != null) && n0(bj.tax) >= 0) ? n0(bj.tax) : taxMoLocal;
    let insMo =
      (bj && (bj.insurance != null) && n0(bj.insurance) >= 0) ? n0(bj.insurance) : insMoLocal;
    let hoaMo =
      (bj && (bj.hoa != null) && n0(bj.hoa) >= 0) ? n0(bj.hoa) : hoaMoLocal;
    const pmiMo =
      (bj && (bj.pmi != null) && n0(bj.pmi) >= 0) ? n0(bj.pmi) : 0;
    // Fold PMI into insurance for your 5-label bars
    insMo = Math.max(0, insMo) + Math.max(0, pmiMo);
    // 4) Split PI into Principal vs Interest (first-month approximation)
    const loan =
      (mj && n0(mj.loanAmount) > 0) ? n0(mj.loanAmount)
      : Math.max(0, n0(localM.loan));
    const mRate = (aprUsed/100)/12;
    const interestMo = loan > 0 ? (loan * mRate) : 0;
    const principalMo = Math.max(0, piCombined - interestMo);
    // 5) Ensure component sum matches all-in as closely as possible
    const compTotal = Math.max(0, principalMo + interestMo + taxMo + insMo + hoaMo);
    if (compTotal > 0) mortgageMonthly = Math.max(mortgageMonthly, compTotal);
    // ‚úÖ Feasibility tiles
    const residualIncome = income - expenses;
    const disposableAfterMortgage = residualIncome - mortgageMonthly;
    const allowances = Math.max(0, (brainTotal>0 ? (brainTotal - brainBase) : 0));
    return {
      income,
      expenses,
      // KPI #4 display (downpayment)
      savings: (ov.savings==null ? n0(b.savings) : Math.max(0, ov.savings)),
      price,
      dpAmt,
      creditScore,
      termYears,
      mortgageMonthly,
      residualIncome,
      disposableAfterMortgage,
      // ‚úÖ breakdown fields for 2A bars
      principalMo,
      interestMo,
      taxMo,
      insMo,
      hoaMo,
      aprUsed,
      __baseIncome: baseIncome,
      __addIncome: (ov.addIncome || 0),
      __brainBase: brainBase,
      __brainAllowances: allowances
    };
  };
  // ---------- Grade (existing) ----------
  function localGrade(s){
    const income = (s.income||1);
    const expenses = n0(s.expenses);
    const mort = n0(s.mortgageMonthly);
    const totalShare = (expenses + mort) / income;
    const housingShare = mort / income;
    let g=92;
    if(totalShare>=0.85) g-=30; else if(totalShare>=0.70) g-=15; else g+=4;
    if(housingShare>0.40) g-=18; else if(housingShare>0.33) g-=8; else g+=4;
    const disp = n0(s.disposableAfterMortgage);
    if (disp<0) g-=30;
    else if((disp/income)<0.10) g-=10;
    else if((disp/income)>=0.20) g+=4;
    g=Math.max(0,Math.min(100,g));
    const letter =
      g>=98?'A+': g>=92?'A': g>=88?'A-'
    : g>=82?'B+': g>=76?'B': g>=72?'B-'
    : g>=66?'C+': g>=60?'C': g>=55?'C-'
    : g>=50?'D+': g>=45?'D':'F';
    return {letter, totalShare};
  }
  // ============================================================
  // ‚úÖ Financial Health Grade (28% rule + disposable %)
  // ============================================================
  function financialHealthGrade28(s){
    const income = Math.max(0, n0(s.income));
    if (income <= 0) return { letter:"‚Äî", housingPct:0, disposablePct:0 };
    const expenses = Math.max(0, n0(s.expenses));
    const mort = Math.max(0, n0(s.mortgageMonthly));
    const totalMonthlyExpenses = expenses + mort;
    const disposable = income - totalMonthlyExpenses;
    const housingPct = mort / income;
    const disposablePct = disposable / income;
    let letter = "F";
    if (disposable < 0 || housingPct > 0.45) {
      letter = "F";
    } else if (housingPct <= 0.28 && disposablePct >= 0.20) {
      letter = "A";
    } else if (housingPct <= 0.28 && disposablePct >= 0.15) {
      letter = "A-";
    } else if (housingPct <= 0.28 && disposablePct >= 0.10) {
      letter = "B+";
    } else if (housingPct <= 0.33 && disposablePct >= 0.10) {
      letter = "B";
    } else if (housingPct <= 0.33 && disposablePct >= 0.05) {
      letter = "C";
    } else if (housingPct <= 0.40 && disposablePct >= 0.00) {
      letter = "D";
    } else {
      letter = "F";
    }
    return { letter, housingPct, disposablePct };
  }
  // ---------- Painter registry ----------
  CORE.painters = CORE.painters || [];
  CORE.registerPainter = function registerPainter(name, fn){
    CORE.painters = (CORE.painters || []).filter(p => p.name !== name);
    CORE.painters.push({ name, fn });
    if (CORE.__booted) setTimeout(()=>CORE.paintAll(), 0);
  };
  CORE.state = CORE.state || {
    barMode: "abs",
    barView: "monthly",
    rentStartOverride: null,
    barChart: null,
    lineChart: null
  };
  // ============================================================
  // ‚úÖ Mortgage Breakdown Row Injector (adds HOA row)
  // ============================================================
  let __breakdownWired = false;
  function ensureMortgageBreakdownRows(){
    if (__breakdownWired) return;
    __breakdownWired = true;
    const bars = document.querySelector('.fs-bars');
    if (!bars) return;
    const rows = bars.querySelectorAll('.fs-row');
    if (rows[0]) rows[0].querySelector('.name') && (rows[0].querySelector('.name').textContent = "Principal");
    if (rows[1]) rows[1].querySelector('.name') && (rows[1].querySelector('.name').textContent = "Interest");
    if (rows[2]) rows[2].querySelector('.name') && (rows[2].querySelector('.name').textContent = "Taxes");
    if (rows[3]) rows[3].querySelector('.name') && (rows[3].querySelector('.name').textContent = "Insurance");
    if (!document.getElementById("fs-bar-hoa")){
      const row = document.createElement("div");
      row.className = "fs-row";
      row.innerHTML = `
        <div class="name">HOA</div>
        <div class="fs-track"><div class="fs-fill housing" id="fs-bar-hoa"></div></div>
        <div class="amt" id="fs-amt-hoa">$‚Äî</div>
      `;
      bars.appendChild(row);
    }
    const note = document.getElementById("fs-note");
    if (note){
      note.textContent = "Bars show the Mortgage Estimate broken down by Principal, Interest, Taxes, Insurance, and HOA.";
    }
  }
  // ============================================================
  // ‚úÖ Bottom label swap: RESIDUAL INCOME ‚Üí MORTGAGE ESTIMATE
  // ============================================================
  function setBottomLabelToMortgage(){
    // Try explicit ids/classes first
    const byId = document.getElementById("fs-residual-label");
    if (byId) { byId.textContent = "MORTGAGE ESTIMATE"; return; }
    const byClass = document.querySelector(".fs-residual-label");
    if (byClass) { byClass.textContent = "MORTGAGE ESTIMATE"; return; }
    // Otherwise, find the closest caption near #fs-residual and change common patterns
    const v = document.getElementById("fs-residual");
    if (!v) return;
    const container = v.closest(".fs-residual, .fs-bottom, .fs-foot, .fs-footer, .fs-row, .fs-tile") || v.parentElement;
    if (!container) return;
    const candidates = container.querySelectorAll("*");
    for (const el of candidates){
      const t = String(el.textContent||"").trim().toUpperCase();
      if (t === "RESIDUAL INCOME"){
        el.textContent = "MORTGAGE ESTIMATE";
        return;
      }
    }
  }
  // ============================================================
  // ‚úÖ FEASIBILITY SNAPSHOT painter (Mortgage Breakdown Bars)
  // ============================================================
  function clampPct(x){ x = Number(x)||0; return Math.max(0, Math.min(100, x)); }
  function setBar(id, pct){
    const el = document.getElementById(id);
    if (!el) return;
    el.style.width = clampPct(pct) + "%";
    el.classList.remove("negative");
  }
  function setFsTileTitleByValueId(valueId, titleText){
    try{
      const vEl = document.getElementById(valueId);
      if (!vEl) return;
      const directId = valueId.replace("fs-","fs-") + "-lbl";
      const direct = document.getElementById(directId);
      if (direct) { direct.textContent = titleText; return; }
      const tile = vEl.closest(".fs-tile, .fs-box, .fs-card, .fs-cell, .tile, .card") || vEl.parentElement;
      if (!tile) return;
      const label =
        tile.querySelector(".lbl") ||
        tile.querySelector(".label") ||
        tile.querySelector(".title") ||
        tile.querySelector(".k") ||
        tile.querySelector(".fs-label") ||
        tile.querySelector(".fs-title") ||
        tile.querySelector("h4") ||
        tile.querySelector("h5");
      if (label) label.textContent = titleText;
    }catch(_){}
  }
  function paintFeasibilitySnapshot(s){
    ensureMortgageBreakdownRows();
    const income   = n0(s.income);
    const expenses = Math.max(0, n0(s.expenses));
    const mortgage = Math.max(0, n0(s.mortgageMonthly));
    const totalMonthlyExpenses = expenses + mortgage;
    const disposableIncome = income - totalMonthlyExpenses;
    // TILE #1
    const incomeEl = document.getElementById("fs-income");
    if (incomeEl) incomeEl.textContent = cur(income,0);
    setFsTileTitleByValueId("fs-income", "TOTAL MONTHLY INCOME");
    const subInc = document.getElementById("fs-income-sub");
    if (subInc){
      const base = n0(s.__brainBase);
      const allow = n0(s.__brainAllowances);
      const add  = n0(s.__addIncome);
      if (base>0 && allow>0){
        subInc.textContent =
          add>0
            ? `Base ${cur(base,0)} + Allowances ${cur(allow,0)} + Add‚Äôl ${cur(add,0)}`
            : `Base ${cur(base,0)} + Allowances ${cur(allow,0)}`;
      } else {
        const bi = n0(s.__baseIncome);
        subInc.textContent =
          add>0 ? `Base ${cur(bi,0)} + Add‚Äôl ${cur(add,0)}` : `Base ${cur(bi,0)}`;
      }
    }
    // TILE #2
    const housingEl = document.getElementById("fs-housing");
    if (housingEl) housingEl.textContent = cur(totalMonthlyExpenses,0);
    setFsTileTitleByValueId("fs-housing", "TOTAL MONTHLY EXPENSES");
    const subHou = document.getElementById("fs-housing-sub");
    if (subHou){
      subHou.textContent = `Monthly Expenses ${cur(expenses,0)} + Mortgage ${cur(mortgage,0)}`;
    }
    // TILE #3
    const expEl = document.getElementById("fs-expenses");
    if (expEl) expEl.textContent = signed(disposableIncome);
    setFsTileTitleByValueId("fs-expenses", "DISPOSABLE INCOME");
    const subExp = document.getElementById("fs-expenses-sub");
    if (subExp){
      if (income > 0){
        const pct = Math.round((disposableIncome / income) * 100);
        subExp.textContent = `${pct}% Based on Total Income - Total Monthly Expenses`;
      } else {
        subExp.textContent = "Based on Total Income - Total Monthly Expenses";
      }
    }
    // TILE #4
    const savEl = document.getElementById("fs-saving");
    const fh = financialHealthGrade28({ income, expenses, mortgageMonthly:mortgage });
    if (savEl) savEl.textContent = fh.letter;
    setFsTileTitleByValueId("fs-saving", "FINANCIAL HEALTH");
    const subSav = document.getElementById("fs-saving-sub");
    if (subSav){
      subSav.textContent = "Based on Disposable Income and Mortgage %";
    }
    // Bars
    const P = Math.max(0, n0(s.principalMo));
    const I = Math.max(0, n0(s.interestMo));
    const T = Math.max(0, n0(s.taxMo));
    const N = Math.max(0, n0(s.insMo));
    const H = Math.max(0, n0(s.hoaMo));
    const total = Math.max(1, (P+I+T+N+H) || mortgage || 1);
    setBar("fs-bar-exp", (P/total)*100);
    setBar("fs-bar-hou", (I/total)*100);
    setBar("fs-bar-sav", (T/total)*100);
    setBar("fs-bar-res", (N/total)*100);
    setBar("fs-bar-hoa", (H/total)*100);
    const aExp = document.getElementById("fs-amt-exp");
    const aHou = document.getElementById("fs-amt-hou");
    const aSav = document.getElementById("fs-amt-sav");
    const aRes = document.getElementById("fs-amt-res");
    const aHoa = document.getElementById("fs-amt-hoa");
    if (aExp) aExp.textContent = cur(P,0);
    if (aHou) aHou.textContent = cur(I,0);
    if (aSav) aSav.textContent = cur(T,0);
    if (aRes) aRes.textContent = cur(N,0);
    if (aHoa) aHoa.textContent = cur(H,0);
    // ‚úÖ Bottom row: MORTGAGE ESTIMATE (All-In)
    setBottomLabelToMortgage();
    const resEl = document.getElementById("fs-residual");
    if (resEl){
      resEl.textContent = cur(mortgage,0);
    }
  }
  // ---------- KPI/Top bar painter ----------
  function paintHeaderKpis(s){
    const ki = $("#k-income");
    const ke = $("#k-expense");
    const km = $("#k-mtg");
    const ks = $("#k-save");
    if (ki) ki.textContent = cur(s.income,0);
    if (ke) ke.textContent = cur(s.expenses,0);
    // KPI #3 stays HOME PRICE (Housing Cost)
    if (km) km.textContent = cur(s.price,0);
    // KPI #4 stays downpayment
    if (ks) ks.textContent = cur(s.savings,0);
    const cs = Number(s.creditScore)||720;
    const kscore = $("#k-score");
    const band = $("#score-band");
    if (kscore) kscore.textContent = cs;
    if (band) band.textContent = `(${bandFromScore(cs)})`;
    const marker = $("#score-marker");
    if (marker){
      const pct = Math.max(0, Math.min(1, (cs - 300) / (850 - 300)));
      marker.style.left = (pct*100) + "%";
    }
    const slider = document.getElementById("score-slider");
    if (slider && document.activeElement !== slider){
      slider.value = String(cs);
    }
    const disp = $("#fid-disp");
    if (disp) disp.textContent = signed(s.disposableAfterMortgage);
    const {letter, totalShare} = localGrade(s);
    const grade = $("#fid-grade");
    const dot = $("#fid-dot");
    const meter = $("#fid-meter");
    if (grade) grade.textContent = letter + " / Disposable";
    if (dot){
      dot.style.background =
        (letter[0]==="A"||letter[0]==="B") ? "var(--ok)"
        : (letter[0]==="C" ? "var(--warn)" : "var(--bad)");
    }
    if (meter) meter.style.width = (Math.max(0, Math.min(1, totalShare))*100) + "%";
  }
  // ---------- KPI edit wiring ----------
  function setEditing(cardId, isEditing){
    const el = document.getElementById(cardId);
    if (!el) return;
    el.classList.toggle("is-editing", !!isEditing);
  }
  function showActions(prefix, mode){
    const edit = document.getElementById(prefix+"-edit");
    const save = document.getElementById(prefix+"-save");
    const cancel = document.getElementById(prefix+"-cancel");
    if (edit) edit.style.display = (mode==="view") ? "" : "none";
    if (save) save.style.display = (mode==="edit") ? "" : "none";
    if (cancel) cancel.style.display = (mode==="edit") ? "" : "none";
  }
  function wireMoneyKpi(opts){
    const card = document.getElementById(opts.cardId);
    const edit = document.getElementById(opts.prefix+"-edit");
    const save = document.getElementById(opts.prefix+"-save");
    const cancel = document.getElementById(opts.prefix+"-cancel");
    const input = document.getElementById(opts.inputId);
    if (!card || !input) return;
    const open = ()=>{
      const ov = readOverrides();
      const s = CORE.snapshotFromBridge();
      input.value = String(opts.onOpenFill({ ov, s }) ?? "");
      setEditing(opts.cardId, true);
      showActions(opts.prefix, "edit");
      input.focus();
      input.select?.();
    };
    const close = ()=>{
      setEditing(opts.cardId, false);
      showActions(opts.prefix, "view");
    };
    const commit = ()=>{
      const n = Math.max(0, Number(input.value || 0) || 0);
      const ov = readOverrides();
      const next = opts.onSaveTransform({ n, ov });
      writeOverrides(next);
      close();
      // ‚úÖ Paint immediately (local calc reacts instantly), then resync mortgage.js and repaint
      CORE.paintAll();
      const mySeq = ++CORE.__mortSeq;
      Promise.resolve()
        .then(()=>CORE.fetchBrain?.())
        .then(()=>CORE.fetchMortgage?.())
        .then(()=>{ if (mySeq === CORE.__mortSeq) CORE.paintAll(); })
        .catch(()=>{});
    };
    edit && edit.addEventListener("click", open);
    cancel && cancel.addEventListener("click", ()=>{ close(); CORE.paintAll(); });
    save && save.addEventListener("click", commit);
    input.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") commit();
      if (e.key === "Escape") { close(); CORE.paintAll(); }
    });
  }
  function wireCreditSlider(){
    const slider = document.getElementById("score-slider");
    const save = document.getElementById("kpi-score-save");
    const cancel = document.getElementById("kpi-score-cancel");
    if (!slider || !save || !cancel) return;
    let baseline = null;
    function enterEdit(){ save.style.display = ""; cancel.style.display = ""; }
    function exitEdit(){ save.style.display = "none"; cancel.style.display = "none"; baseline = null; }
    slider.addEventListener("pointerdown", ()=>{
      const s = CORE.snapshotFromBridge();
      baseline = Number(s.creditScore) || 720;
      enterEdit();
    });
    slider.addEventListener("input", ()=>{
      const liveDraft = Number(slider.value) || 720;
      // save override
      const ov = readOverrides();
      ov.creditScore = Math.max(300, Math.min(850, liveDraft));
      writeOverrides(ov);
      // ‚úÖ IMMEDIATE update (local calc responds instantly because snapshot reads overrides)
      CORE.paintAll();
      // ‚úÖ Then fetch mortgage.js with new score and repaint when it returns (no stale results)
      const mySeq = ++CORE.__mortSeq;
      Promise.resolve()
        .then(()=>CORE.fetchBrain?.())
        .then(()=>CORE.fetchMortgage?.())
        .then(()=>{ if (mySeq === CORE.__mortSeq) CORE.paintAll(); })
        .catch(()=>{});
    });
    save.addEventListener("click", ()=>{ exitEdit(); CORE.paintAll(); });
    cancel.addEventListener("click", ()=>{
      const ov = readOverrides();
      if (baseline != null){
        ov.creditScore = Math.max(300, Math.min(850, baseline));
      } else {
        delete ov.creditScore;
      }
      writeOverrides(ov);
      // ‚úÖ immediate local repaint
      CORE.paintAll();
      // ‚úÖ resync mortgage.js and repaint
      const mySeq = ++CORE.__mortSeq;
      Promise.resolve()
        .then(()=>CORE.fetchBrain?.())
        .then(()=>CORE.fetchMortgage?.())
        .then(()=>{ if (mySeq === CORE.__mortSeq) CORE.paintAll(); })
        .catch(()=>{});
      exitEdit();
    });
  }
  function wireExport(){
    const btn = document.getElementById("fid-export");
    if (!btn || btn.__wired) return;
    btn.__wired = true;
    btn.addEventListener("click", async ()=>{
      const el = document.getElementById("fid-card");
      if (!el) return;
      const rect = el.getBoundingClientRect();
      const scale = Math.max(2, window.devicePixelRatio || 2);
      const cloned = el.cloneNode(true);
      const serializer = new XMLSerializer();
      const markup = serializer.serializeToString(cloned);
      const svg = '<svg xmlns="http://www.w3.org/2000/svg" width="'+(rect.width*scale)+'" height="'+(rect.height*scale)+'">' +
                    '<foreignObject x="0" y="0" width="100%" height="100%">' +
                      markup +
                    '</foreignObject>' +
                  '</svg>';
      const blob = new Blob([svg], {type:"image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = ()=>{
        const canvas = document.createElement("canvas");
        canvas.width = rect.width*scale;
        canvas.height = rect.height*scale;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#0f1220";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        URL.revokeObjectURL(url);
        const a = document.createElement("a");
        a.download = "Fiduciary-Snapshot.png";
        a.href = canvas.toDataURL("image/png");
        a.click();
      };
      img.src = url;
    });
  }
  // ---------- Core paintAll ----------
  CORE.paintAll = function paintAll(){
    const s = CORE.snapshotFromBridge();
    const ov = getOv();
    // keep inputs synced when not editing
    const addIn = document.getElementById("in-addIncome");
    const exIn  = document.getElementById("in-expensesOverride");
    const hoIn  = document.getElementById("in-housingOverride");
    const saIn  = document.getElementById("in-savingsOverride");
    if (addIn && !document.getElementById("kpi-income")?.classList.contains("is-editing")) addIn.value = String(ov.addIncome || 0);
    if (exIn  && !document.getElementById("kpi-expense")?.classList.contains("is-editing")) exIn.value  = String(ov.expenses==null ? "" : ov.expenses);
    if (hoIn  && !document.getElementById("kpi-mtg")?.classList.contains("is-editing"))    hoIn.value  = String(ov.housing==null ? "" : ov.housing);
    if (saIn  && !document.getElementById("kpi-save")?.classList.contains("is-editing"))   saIn.value  = String(ov.savings==null ? "" : ov.savings);
    paintHeaderKpis(s);
    paintFeasibilitySnapshot(s);
    // publish feasibility snapshot + BLUF verdict
    publishFeasibility(s);
    (CORE.painters || []).forEach(p=>{
      try{ p.fn({ s, brain: CORE.brain, bridge: CORE.bridge, state: CORE.state, utils: CORE.utils }); }catch(_){}
    });
  };
  // ---------- expose utils ----------
  CORE.utils = CORE.utils || {};
  Object.assign(CORE.utils, { $, cur, signed, pmti, scoreAPR, bandFromScore, pickFirst });
  // ---------- Boot ----------
  onReady(async ()=>{
    loadBridge();
    // KPI #1 add income
    wireMoneyKpi({
      cardId:"kpi-income", prefix:"kpi-income",
      inputId:"in-addIncome",
      onOpenFill: ({ov}) => Number(pickFirst(ov, ["addIncome","add_income"]) || 0) || 0,
      onSaveTransform: ({n, ov}) => { ov.addIncome = Math.max(0, n); return ov; }
    });
    // KPI #2 expenses override
    wireMoneyKpi({
      cardId:"kpi-expense", prefix:"kpi-expense",
      inputId:"in-expensesOverride",
      onOpenFill: ({ov, s}) => {
        const v = numOrNull(pickFirst(ov, ["expensesOverride","expenses","monthlyExpenses"]));
        return (v==null ? s.expenses : v);
      },
      onSaveTransform: ({n, ov}) => { ov.expensesOverride = Math.max(0, n); return ov; }
    });
    // KPI #3 home price override
    wireMoneyKpi({
      cardId:"kpi-mtg", prefix:"kpi-mtg",
      inputId:"in-housingOverride",
      onOpenFill: ({ov, s}) => {
        const v = numOrNull(pickFirst(ov, ["housingOverride","housing","homePrice","priceOverride"]));
        return (v==null ? s.price : v);
      },
      onSaveTransform: ({n, ov}) => { ov.housingOverride = Math.max(0, n); return ov; }
    });
    // KPI #4 downpayment override
    wireMoneyKpi({
      cardId:"kpi-save", prefix:"kpi-save",
      inputId:"in-savingsOverride",
      onOpenFill: ({ov, s}) => {
        const v = numOrNull(pickFirst(ov, ["savingsOverride","savings","downpayment","dpAmt"]));
        return (v==null ? s.savings : v);
      },
      onSaveTransform: ({n, ov}) => { ov.savingsOverride = Math.max(0, n); return ov; }
    });
    wireCreditSlider();
    wireExport();
    // ‚úÖ Load brain + mortgage breakdown before first paint (best effort)
    await CORE.fetchBrain();
    await CORE.fetchMortgage();
    CORE.__booted = true;
    CORE.paintAll();
    // ‚úÖ If mortgage returns slightly after first render (cache/network), repaint once more
    setTimeout(async ()=>{
      const before = CORE.mortgage?.ok ? (CORE.mortgage?.breakdown?.allIn || 0) : 0;
      await CORE.fetchMortgage();
      const after = CORE.mortgage?.ok ? (CORE.mortgage?.breakdown?.allIn || 0) : 0;
      if (after !== before) CORE.paintAll();
    }, 250);
  });
})();
</script>
  </div>
  <div class="w-embed w-script">
    <script>
(() => {
  /* ============================================================
     //#2B ‚Äî MONTHLY EXPENSES (DRAGGABLE + SCROLLABLE BARS)
     UPDATE (Requested):
     - REMOVE "Housing" from the bars entirely (Monthly Expenses only)
     - Utilities still SEEDS from City Average Utilities
       ‚úÖ BUT is now adjustable like every other bar (drag + scroll wheel)
     - Keeps: $ amount INSIDE each bar (always visible)
     - Keeps: "Monthly Expense" input (live sum) + Update button
     ‚úÖ FIX (Requested):
     - Clicking Update MUST update the TOP KPI "TOTAL MONTHLY EXPENSE"
       by writing to:
         1) CORE.bridge.expenses
         2) localStorage "realtysass.bridge"
         3) localStorage "realtysass.kpi_overrides.v1" -> expensesOverride (primary)
            + expenses (back-compat)
       - Then trigger CORE.paintAll()
     Notes:
     - We STILL compute + store a derived monthly mortgage (for other modules),
       but it is NOT part of these bars anymore.
       localStorage: "realtysass.derived.housing_monthly.v1"
       CORE.state.__rsMonthlyMortgage
  ============================================================ */
  const CORE = window.RS_FID;
  if (!CORE || !CORE.__coreMounted) return;
  const { cur } = CORE.utils;
  // ‚úÖ Housing removed
  const BUCKETS = ["Utilities","Debt","Transportation","Food","Health","Entertainment","Other"];
  const LOCKED  = new Set([]); // none locked now
  const COLOR = {
    Utilities: "#8ab6ff",
    Debt: "#f9c74f",
    Transportation: "#55d399",
    Food: "#8ef3c5",
    Health: "#6aa7ff",
    Entertainment: "#b58cff",
    Other: "#6e7a94"
  };
  const STORE_KEY = "realtysass.expense_buckets.v1";
  const DERIVED_MTG_KEY = "realtysass.derived.housing_monthly.v1";
  // ---------- helpers ----------
  const clamp  = (n,min,max)=> Math.max(min, Math.min(max, n));
  const round0 = (n)=> Math.round(Number(n)||0);
  function safeParseJSON(s){
    try{ return JSON.parse(s); }catch(_){ return null; }
  }
  function sumModel(model){
    return BUCKETS.reduce((a,k)=> a + (Number(model[k])||0), 0);
  }
  function num(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }
  function pick(obj, keys){
    if (!obj || typeof obj !== "object") return null;
    for (const k of keys){
      if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
    }
    return null;
  }
  /* ============================================================
     //#2B.1 ‚Äî CITY UTILITIES (SEED BASELINE)
  ============================================================ */
  function getCityUtilitiesAvg(){
    try{
      const beds =
        Number((CORE.bridge && (CORE.bridge.beds || CORE.bridge.bedrooms || CORE.bridge.bedroom)) || 0) ||
        Number((CORE.brain && CORE.brain.profile && CORE.brain.profile.beds) || 0) ||
        4;
      const city = (CORE.brain && CORE.brain.city) ? CORE.brain.city : {};
      const raw  = city.raw || {};
      const byBed =
        city.by_bedroom || raw.by_bedroom ||
        city.bedrooms || raw.bedrooms ||
        null;
      const blk = byBed ? (byBed[String(beds)] || byBed[beds]) : null;
      const u = blk && blk.utilities ? blk.utilities : null;
      const avg = u && u.total ? Number(u.total.avg || 0) : 0;
      if (avg > 0) return avg;
      const low = u && u.total ? Number(u.total.low || 0) : 0;
      const high= u && u.total ? Number(u.total.high || 0) : 0;
      if (low>0 && high>0) return (low+high)/2;
    }catch(_){}
    return null;
  }
  /* ============================================================
     //#2B.2 ‚Äî APR BAND (DETERMINISTIC) + PI PAYMENT
     (Used ONLY to derive and store monthly mortgage for other modules)
  ============================================================ */
  function aprFromScore(score){
    const s = Number(score)||0;
    if (s >= 780) return 6.10;
    if (s >= 760) return 6.25;
    if (s >= 740) return 6.45;
    if (s >= 720) return 6.65;
    if (s >= 700) return 6.95;
    if (s >= 680) return 7.25;
    if (s >= 660) return 7.55;
    if (s >= 640) return 7.85;
    return 8.25;
  }
  function pmtMonthlyPI(loan, aprPct, years){
    const L = Math.max(0, Number(loan)||0);
    const apr = Math.max(0, Number(aprPct)||0) / 100;
    const n = Math.max(1, Math.round((Number(years)||30) * 12));
    const r = apr / 12;
    if (L <= 0) return 0;
    if (r <= 0) return L / n;
    const pow = Math.pow(1+r, n);
    return L * (r * pow) / (pow - 1);
  }
  function getExplicitMonthlyMortgage(s){
    const cand = [
      s.monthlyMortgage, s.mortgageMonthly, s.mortgage_estimate, s.mortgageEstimate,
      s.housingMonthly, s.housing_monthly, s.allInHousing, s.all_in_housing
    ];
    for (const v of cand){
      const n = num(v);
      if (n && n > 0 && n < 25000) return n;
    }
    const b = CORE.bridge || {};
    const candB = [
      b.monthlyMortgage, b.mortgageMonthly, b.mortgage_estimate, b.housingMonthly,
      b.housing_monthly, b.allInHousing, b.all_in_housing
    ];
    for (const v of candB){
      const n = num(v);
      if (n && n > 0 && n < 25000) return n;
    }
    const cached = safeParseJSON(localStorage.getItem(DERIVED_MTG_KEY) || "null");
    if (cached && num(cached.value)) return Number(cached.value);
    return null;
  }
  function deriveMonthlyMortgageFromPrice(s){
    const price = Math.max(0, Number(s.housing)||0);          // purchase price (KPI #3)
    const down  = Math.max(0, Number(s.savings)||0);          // downpayment (KPI #4)
    const score = Math.max(300, Math.min(850, Number(s.creditScore||0) || 720));
    const termYears = Number(
      pick(s, ["termYears","term_years","mortgageTermYears","loanTermYears"]) || 30
    ) || 30;
    const apr = Number(
      pick(s, ["apr","APR","interestRate","rate","mortgageApr","mortgageAPR"]) || aprFromScore(score)
    ) || aprFromScore(score);
    // Backward compatible: if "housing" is actually monthly already (small), treat it as monthly
    if (price > 0 && price < 25000) return price;
    if (!price || price < 50000) return 0;
    const loan = Math.max(0, price - down);
    const pi = pmtMonthlyPI(loan, apr, termYears);
    const tihoa = Math.max(0, Number(pick(s, ["tihoa","TIHOA","taxInsuranceHoa","tax_ins_hoa"]) || 0));
    const pmi   = Math.max(0, Number(pick(s, ["pmi","PMI"]) || 0));
    return Math.max(0, pi + tihoa + pmi);
  }
  function computeDerivedMonthlyMortgage(s){
    const explicit = getExplicitMonthlyMortgage(s);
    if (explicit != null) return explicit;
    return deriveMonthlyMortgageFromPrice(s) || 0;
  }
  function storeDerivedMonthlyMortgage(value, meta){
    const v = round0(value);
    CORE.state = CORE.state || {};
    CORE.state.__rsMonthlyMortgage = v;
    try{
      localStorage.setItem(DERIVED_MTG_KEY, JSON.stringify({
        value: v,
        meta: meta || {},
        updatedAt: new Date().toISOString()
      }));
    }catch(_){}
  }
  /* ============================================================
     //#2B.3 ‚Äî CHART.JS LOADER
  ============================================================ */
  function ensureChartJs(){
    return new Promise((resolve)=>{
      if (window.Chart) return resolve(true);
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js";
      s.onload = ()=>resolve(true);
      s.onerror = ()=>resolve(false);
      document.head.appendChild(s);
    });
  }
  function ensureControls(canvas){
    const card = canvas.closest(".card-mini") || canvas.closest(".sec-card") || canvas.parentElement;
    if (!card) return { input:null, btn:null };
    const oldControls = card.querySelector(".controls");
    if (oldControls) oldControls.remove();
    const h3 = card.querySelector("h3");
    const anchor = h3 ? h3.nextElementSibling : card.firstChild;
    const controls = document.createElement("div");
    controls.className = "controls";
    controls.style.cssText = "display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:4px 0 10px;";
    controls.innerHTML = `
      <div style="flex:1;min-width:220px;">
        <div style="display:flex;align-items:center;gap:10px;background:#0f1326;border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px 12px;">
          <div style="font-size:12px;letter-spacing:.2px;text-transform:uppercase;font-weight:700;color:#e9ecff;opacity:.9;">
            Monthly Expense
          </div>
          <input id="rs-exp-total-input" inputmode="numeric"
            style="margin-left:auto;width:140px;background:transparent;border:0;outline:none;color:#fff;font-weight:800;font-size:14px;text-align:right;"
            value="" />
        </div>
      </div>
      <button id="rs-exp-apply"
        style="padding:10px 14px;border-radius:12px;border:1px solid rgba(142,243,197,.55);background:#0f1326;color:#fff;font-weight:800;cursor:pointer;box-shadow:0 0 0 2px rgba(106,167,255,.12) inset;">
        Update
      </button>
      <div style="margin-left:auto;font-size:12px;color:rgba(233,236,255,.75);white-space:nowrap;">
        Drag bars ‚Ä¢ Scroll over a bar to adjust ‚Ä¢ Utilities seeds from city avg
      </div>
    `;
    if (anchor) card.insertBefore(controls, anchor);
    else card.appendChild(controls);
    return {
      input: controls.querySelector("#rs-exp-total-input"),
      btn: controls.querySelector("#rs-exp-apply")
    };
  }
  /* ============================================================
     //#2B.4 ‚Äî MODEL (LOAD / DEFAULTS)
     - Utilities seeds from city avg
     - Utilities stays auto-synced to city avg ONLY until user edits it once
  ============================================================ */
  function buildModelFromStorageOrDefaults(s){
    const utilAvg = Math.max(0, Number(getCityUtilitiesAvg() || 0));
    const saved = safeParseJSON(localStorage.getItem(STORE_KEY) || "null");
    if (saved && saved.buckets && typeof saved.buckets === "object"){
      const model = {};
      for (const k of BUCKETS) model[k] = Math.max(0, Number(saved.buckets[k]||0));
      // If we have meta saying Utilities was never edited, re-seed to current city avg
      const meta = saved.meta || {};
      const utilEdited = !!meta.utilitiesUserEdited;
      if (!utilEdited && utilAvg > 0){
        model.Utilities = utilAvg;
        CORE.state = CORE.state || {};
        CORE.state.__utilitiesUserEdited = false;
        CORE.state.__utilitiesBaseline = utilAvg;
      }else{
        CORE.state = CORE.state || {};
        CORE.state.__utilitiesUserEdited = utilEdited;
        CORE.state.__utilitiesBaseline = utilAvg || Number(model.Utilities)||0;
      }
      return model;
    }
    // base target: use s.expenses if present (user‚Äôs total)
    const targetBase = Math.max(0, Number(s.expenses)||0);
    const target     = Math.max(targetBase, utilAvg);
    const remain     = Math.max(0, target - utilAvg);
    const ratios = {
      Debt: 0.22, Transportation: 0.18, Food: 0.28,
      Health: 0.14, Entertainment: 0.10, Other: 0.08
    };
    CORE.state = CORE.state || {};
    CORE.state.__utilitiesUserEdited = false;
    CORE.state.__utilitiesBaseline = utilAvg;
    return {
      Utilities: utilAvg,
      Debt: remain * ratios.Debt,
      Transportation: remain * ratios.Transportation,
      Food: remain * ratios.Food,
      Health: remain * ratios.Health,
      Entertainment: remain * ratios.Entertainment,
      Other: remain * ratios.Other
    };
  }
  function computeDynamicYMax(model){
    const vals = BUCKETS.map(k => Number(model[k])||0);
    const maxV = Math.max(...vals, 0);
    const min  = 500;
    const pad  = 1.25;
    return Math.max(min, Math.ceil((maxV * pad) / 50) * 50);
  }
  function persistModel(model){
    try{
      CORE.state = CORE.state || {};
      const utilAvg = Math.max(0, Number(getCityUtilitiesAvg() || CORE.state.__utilitiesBaseline || 0));
      const utilEdited = !!CORE.state.__utilitiesUserEdited;
      localStorage.setItem(STORE_KEY, JSON.stringify({
        total: round0(sumModel(model)),
        buckets: Object.fromEntries(BUCKETS.map(k=>[k, round0(model[k]) ])),
        meta: {
          utilitiesBaseline: round0(utilAvg),
          utilitiesUserEdited: utilEdited
        },
        updatedAt: new Date().toISOString()
      }));
    }catch(_){}
  }
  // ‚úÖ FIX: Commit total in the exact keys #2A expects
  function commitTotalToSystem(total){
    const t = round0(total);
    // 1) Bridge
    try{
      CORE.bridge = CORE.bridge || {};
      CORE.bridge.expenses = t;
      localStorage.setItem("realtysass.bridge", JSON.stringify(CORE.bridge));
    }catch(_){}
    // 2) KPI overrides (PRIMARY for #2A)
    try{
      const k = safeParseJSON(localStorage.getItem("realtysass.kpi_overrides.v1") || "{}") || {};
      // Primary key used by #2A
      k.expensesOverride = t;
      // Back-compat keys (harmless, helps older readers)
      k.expenses = t;
      k.expensesMonthly = t;
      localStorage.setItem("realtysass.kpi_overrides.v1", JSON.stringify(k));
    }catch(_){}
    // 3) Update top input immediately (if present) so UI reflects instantly
    try{
      const topInput = document.getElementById("in-expensesOverride");
      if (topInput) topInput.value = String(t);
    }catch(_){}
    // 4) Repaint
    try{
      if (typeof CORE.paintAll === "function") CORE.paintAll();
      else if (typeof CORE.requestRepaint === "function") CORE.requestRepaint();
      else if (typeof CORE.repaint === "function") CORE.repaint();
    }catch(_){}
  }
  /* ============================================================
     //#2B.5 ‚Äî VALUE LABELS PLUGIN (DRAW $ INSIDE BARS)
  ============================================================ */
  const rsValueLabels = {
    id: "rsValueLabels",
    afterDatasetsDraw(chart, _args, pluginOptions){
      try{
        const opts = pluginOptions || {};
        const dsIndex = Number.isFinite(opts.datasetIndex) ? opts.datasetIndex : 0;
        const meta = chart.getDatasetMeta(dsIndex);
        if (!meta || !meta.data || !meta.data.length) return;
        const ctx = chart.ctx;
        const values = chart.data?.datasets?.[dsIndex]?.data || [];
        ctx.save();
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.font = "800 11px Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillStyle = "#ffffff";
        ctx.strokeStyle = "rgba(0,0,0,.65)";
        ctx.lineWidth = 3;
        for (let i = 0; i < meta.data.length; i++){
          const el = meta.data[i];
          const raw = Number(values[i]) || 0;
          if (raw <= 0) continue;
          const x = el.x;
          const yTop = el.y;
          const yBase = el.base;
          const barH = Math.abs(yBase - yTop);
          const label = cur(raw, 0);
          let y = yTop + 14;
          let drawInside = true;
          if (barH < 26){
            y = yTop - 10;
            drawInside = false;
          }
          if (drawInside){
            y = Math.min(y, yBase - 10);
          }
          ctx.strokeText(label, x, y);
          ctx.fillText(label, x, y);
        }
        ctx.restore();
      }catch(_){}
    }
  };
  /* ============================================================
     //#2B.6 ‚Äî CHART INIT / WRITE
  ============================================================ */
  function initChart(){
    const canvas = document.getElementById("fid-bars");
    if (!canvas || !window.Chart) return null;
    const ctx = canvas.getContext("2d");
    const chart = new Chart(ctx,{
      type:"bar",
      data:{
        labels: BUCKETS,
        datasets: [{
          label: "This Month",
          data: BUCKETS.map(()=>0),
          backgroundColor: BUCKETS.map(k=> COLOR[k] || "#6e7a94"),
          borderWidth: 0,
          borderRadius: 10
        }]
      },
      plugins: [rsValueLabels],
      options:{
        animation: { duration: 0 },
        plugins:{
          legend:{ display:true, labels:{ color:"#fff", boxWidth:12 } },
          tooltip:{
            callbacks:{
              label:(c)=> `${c.label}: ${cur(c.raw,0)}`
            }
          },
          rsValueLabels: { datasetIndex: 0 }
        },
        scales:{
          x:{ ticks:{ color:"#fff" }, grid:{ color:"rgba(255,255,255,.06)" } },
          y:{
            beginAtZero:true,
            ticks:{ color:"#fff" },
            grid:{ color:"rgba(255,255,255,.06)" }
          }
        },
        responsive:true,
        maintainAspectRatio:false
      }
    });
    const ro = new ResizeObserver(()=> chart.resize());
    const holder = canvas.closest(".chart-holder");
    if (holder) ro.observe(holder);
    return chart;
  }
  function writeChart(chart, model){
    chart.data.labels = BUCKETS;
    chart.data.datasets[0].data = BUCKETS.map(k=> round0(model[k]));
    chart.options.scales.y.max  = computeDynamicYMax(model);
    chart.update("none");
  }
  /* ============================================================
     //#2B.7 ‚Äî DRAG + SCROLL ENGINE
  ============================================================ */
  function wireDrag(chart){
    if (chart.__rsDragWired) return;
    chart.__rsDragWired = true;
    const canvas = chart.canvas;
    canvas.style.pointerEvents = "auto";
    canvas.style.touchAction = "none";
    const drag = { active:false, idx:-1 };
    function relPos(ev){
      const r = canvas.getBoundingClientRect();
      return { x: ev.clientX - r.left, y: ev.clientY - r.top };
    }
    function nearestBucketIndexFromX(px){
      const xScale = chart.scales.x;
      let best = -1, bestD = Infinity;
      for (let i=0; i<BUCKETS.length; i++){
        const cx = xScale.getPixelForValue(i);
        const d = Math.abs(px - cx);
        if (d < bestD){ bestD = d; best = i; }
      }
      return best;
    }
    function yPixelToValue(py){
      const yScale = chart.scales.y;
      return yScale.getValueForPixel(py);
    }
    function canDragIndex(i){
      const label = BUCKETS[i];
      return !!label && !LOCKED.has(label);
    }
    function updateMonthlyInput(){
      const input = CORE.state.__expInput;
      if (!input) return;
      input.value = String(round0(sumModel(CORE.state.__expModel || {})));
    }
    function markEdited(label){
      if (label === "Utilities"){
        CORE.state = CORE.state || {};
        CORE.state.__utilitiesUserEdited = true;
      }
    }
    function applyValue(i, nextVal){
      const model = CORE.state.__expModel;
      if (!model) return;
      const label = BUCKETS[i];
      if (!label || LOCKED.has(label)) return;
      const yMax = (chart.options?.scales?.y?.max) || 5000;
      const v = clamp(Math.max(0, nextVal), 0, yMax * 1.5);
      model[label] = v;
      markEdited(label);
      writeChart(chart, model);
      persistModel(model);
      updateMonthlyInput();
    }
    function setCursorFromEvent(ev){
      const { x } = relPos(ev);
      const idx = nearestBucketIndexFromX(x);
      canvas.style.cursor = canDragIndex(idx) ? "ns-resize" : "default";
    }
    canvas.addEventListener("pointermove", (ev)=>{
      if (!drag.active) setCursorFromEvent(ev);
    });
    canvas.addEventListener("pointerdown", (ev)=>{
      const { x, y } = relPos(ev);
      const idx = nearestBucketIndexFromX(x);
      if (!canDragIndex(idx)) return;
      drag.active = true;
      drag.idx = idx;
      canvas.setPointerCapture(ev.pointerId);
      const v = yPixelToValue(y);
      applyValue(idx, v);
      ev.preventDefault();
    });
    canvas.addEventListener("pointermove", (ev)=>{
      if (!drag.active) return;
      const { y } = relPos(ev);
      const v = yPixelToValue(y);
      applyValue(drag.idx, v);
      ev.preventDefault();
    });
    function end(ev){
      if (!drag.active) return;
      drag.active = false;
      drag.idx = -1;
      try{ canvas.releasePointerCapture(ev.pointerId); }catch(_){}
      setCursorFromEvent(ev);
      ev.preventDefault();
    }
    canvas.addEventListener("pointerup", end);
    canvas.addEventListener("pointercancel", end);
    canvas.addEventListener("pointerleave", (ev)=>{ if (drag.active) end(ev); });
    canvas.addEventListener("wheel", (ev)=>{
      try{
        const { x } = relPos(ev);
        const idx = nearestBucketIndexFromX(x);
        if (!canDragIndex(idx)) return;
        const model = CORE.state.__expModel;
        if (!model) return;
        const label = BUCKETS[idx];
        const current = Math.max(0, Number(model[label])||0);
        const stepBase = ev.shiftKey ? 250 : (ev.altKey || ev.metaKey) ? 10 : 50;
        const dir = (ev.deltaY < 0) ? +1 : -1; // wheel up increases
        const next = current + (dir * stepBase);
        applyValue(idx, next);
        ev.preventDefault();
      }catch(_){}
    }, { passive:false });
  }
  /* ============================================================
     //#2B.8 ‚Äî MOUNT / UPDATE
  ============================================================ */
  function mountOrUpdateUI(s){
    CORE.state = CORE.state || {};
    CORE.state.__expS = s;
    // ‚úÖ still compute + store derived mortgage (NOT part of bars anymore)
    const derivedMtg = Math.max(0, computeDerivedMonthlyMortgage(s));
    storeDerivedMonthlyMortgage(derivedMtg, {
      source: "2B",
      note: "Derived monthly mortgage stored for other modules; Housing removed from bars.",
      price: Number(s.housing)||0,
      down: Number(s.savings)||0,
      score: Number(s.creditScore)||0
    });
    if (!CORE.state.barChart){
      CORE.state.barChart = initChart();
      if (!CORE.state.barChart) return;
      wireDrag(CORE.state.barChart);
    }
    if (!CORE.state.__expModel){
      CORE.state.__expModel = buildModelFromStorageOrDefaults(s);
    }else{
      const utilAvg = Math.max(0, Number(getCityUtilitiesAvg() || 0));
      if (!CORE.state.__utilitiesUserEdited && utilAvg > 0){
        CORE.state.__expModel.Utilities = utilAvg;
      }
    }
    const canvas = document.getElementById("fid-bars");
    if (!canvas) return;
    const { input, btn } = ensureControls(canvas);
    CORE.state.__expInput = input;
    if (input){
      input.value = String(round0(sumModel(CORE.state.__expModel)));
      if (!input.__wired){
        input.__wired = true;
        input.addEventListener("input", ()=>{
          const raw = String(input.value||"").replace(/[^\d]/g,"");
          const desired = Number(raw||0);
          const model = CORE.state.__expModel;
          const current = sumModel(model);
          const delta = desired - current;
          model.Other = Math.max(0, (Number(model.Other)||0) + delta);
          writeChart(CORE.state.barChart, model);
          persistModel(model);
          input.value = String(round0(sumModel(model)));
        });
      }
    }
    if (btn && !btn.__wired){
      btn.__wired = true;
      btn.addEventListener("click", ()=>{
        const total = sumModel(CORE.state.__expModel || {});
        commitTotalToSystem(total);
      });
    }
    writeChart(CORE.state.barChart, CORE.state.__expModel);
    persistModel(CORE.state.__expModel);
  }
  CORE.registerPainter("monthly-expenses", async ({ s })=>{
    const ok = await ensureChartJs();
    if (!ok) return;
    mountOrUpdateUI(s);
  });
})();
</script>
  </div>
  <div class="w-embed w-script">
    <script>
(() => {
  // ============================================================
  // Section C: City Estimates (rent/home/mortgage/utilities)
  // ‚úÖ Bedroom stepper (‚ñ≤/‚ñº) next to ct-beds
  // ‚úÖ Mouse wheel scroll on the stepper to adjust
  // ‚úÖ Override persists in localStorage
  // ‚úÖ CLEAN UI: NO "MANUAL" + NO "RESET" text shown
  //    - Hidden reset: double-click the bedroom number (or arrow pill) to return to AUTO
  //
  // ‚úÖ Keeps:
  // - NO fallback city (must resolve from PCS base)
  // - Family->Bedrooms rule:
  //    * family 1‚Äì3 => 2 bed
  //    * family 4 => 3 bed
  //    * family 5 => 4 bed
  //    * family >= 6 => 5 bed
  // ============================================================
  const CORE = window.RS_FID;
  if (!CORE || !CORE.__coreMounted) return;
  const { cur, pickFirst } = CORE.utils;
  // ---------- constants ----------
  const BEDS_OVERRIDE_KEY = "realtysass.cityTargets.bedsOverride.v1";
  const BEDS_MIN = 1;
  const BEDS_MAX = 9;
  // ---------- helpers ----------
  const safeNum = (x)=> {
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  };
  function numFromAny(x){
    if (x == null) return null;
    if (typeof x === "number") return safeNum(x);
    if (typeof x === "string") return safeNum(x.replace(/[^\d.-]/g,""));
    if (typeof x === "object"){
      const v = x.avg ?? x.value ?? x.amount ?? x.median ?? x.mean ?? x.price ?? x.rent ?? x.total ?? null;
      return numFromAny(v);
    }
    return null;
  }
  function avgFromLowHigh(low, high){
    const L = numFromAny(low);
    const H = numFromAny(high);
    if (L==null || H==null) return null;
    if (L<=0 && H<=0) return null;
    return (L + H) / 2;
  }
  function metricBlock(x){
    if (typeof x === "number" || typeof x === "string") return { avg: numFromAny(x) };
    if (x && typeof x === "object") return x;
    return {};
  }
  function deepPick(obj, keys, maxDepth=6){
    try{
      const want = new Set(keys.map(String));
      const seen = new Set();
      const q = [{ v: obj, d: 0 }];
      while(q.length){
        const { v, d } = q.shift();
        if (!v || typeof v !== "object") continue;
        if (seen.has(v)) continue;
        seen.add(v);
        for (const k of Object.keys(v)){
          if (want.has(k)){
            const got = v[k];
            if (got !== undefined && got !== null && got !== "") return got;
          }
        }
        if (d < maxDepth){
          for (const k of Object.keys(v)){
            const child = v[k];
            if (child && typeof child === "object") q.push({ v: child, d: d+1 });
          }
        }
      }
    }catch(_){}
    return null;
  }
  function setTileLabel(nth, text){
    const el = document.querySelector(`#city-targets-card .city-grid .city-tile:nth-child(${nth}) .lbl`);
    if (el) el.textContent = text;
  }
  function hideGapPill(){
    const pill = document.getElementById("ct-gap-pill");
    if (pill) pill.style.display = "none";
  }
  function fmtMoneyRange(low, high){
    const L = numFromAny(low), H = numFromAny(high);
    if (L==null || H==null) return null;
    if (L<=0 && H<=0) return null;
    return `${cur(L,0)} ‚Äì ${cur(H,0)}`;
  }
  function utilitiesFromBridge(){
    const b = CORE.bridge || {};
    const rows = Array.isArray(b.itemizedRows) ? b.itemizedRows : [];
    if (!rows.length){
      const ex = Number(b.expenses)||0;
      return ex>0 ? (ex * 0.12) : null;
    }
    const rx = /(util|electric|power|water|gas|sewer|trash|phone|internet|wifi)/i;
    let sum = 0;
    for (const r of rows){
      const name = String(r.name||r.item||"");
      const amt  = Number(r.amount||r.monthly||r.value||0)||0;
      if (rx.test(name)) sum += Math.max(0, amt);
    }
    return sum>0 ? sum : null;
  }
  // ---------- profile + base ----------
  function getProfile(){
    return CORE.brain?.profileEffective || CORE.brain?.profile || {};
  }
  function getFamilySize(profile){
    const n = Number(pickFirst(profile, [
      "familySize","family_size","family",
      "dependents_count","dependentsCount","dependents"
    ]) ?? 0);
    return Number.isFinite(n) && n > 0 ? Math.round(n) : 0;
  }
  function deriveBedroomsFromFamily(profile){
    const fam = getFamilySize(profile);
    if (!fam) return { beds: 2, fam: 0, rule: "default:2 (family missing)" };
    if (fam <= 3) return { beds: 2, fam, rule: "family 1‚Äì3 => 2 bed" };
    if (fam >= 6) return { beds: 5, fam, rule: "family >= 6 => 5 bed (cap)" };
    return { beds: Math.max(2, Math.min(5, fam - 1)), fam, rule: "beds = family - 1 (2..5 cap)" };
  }
  function getPcsBase(profile){
    const base =
      pickFirst(profile, ["pcs_base","pcsBase","base","duty_station","station","dutyStation"]) ??
      pickFirst(CORE.brain?.profile || {}, ["pcs_base","pcsBase","base","duty_station","station","dutyStation"]) ??
      "";
    return String(base || "").trim();
  }
  // ---------- beds override ----------
  function readBedsOverride(){
    try{
      const raw = localStorage.getItem(BEDS_OVERRIDE_KEY);
      const n = parseInt(String(raw||""), 10);
      if (Number.isFinite(n) && n >= BEDS_MIN && n <= BEDS_MAX) return n;
    }catch(_){}
    return null;
  }
  function writeBedsOverride(n){
    try{
      if (n == null) localStorage.removeItem(BEDS_OVERRIDE_KEY);
      else localStorage.setItem(BEDS_OVERRIDE_KEY, String(n));
    }catch(_){}
  }
  function clampBeds(n){
    const x = Math.round(Number(n)||0);
    return Math.max(BEDS_MIN, Math.min(BEDS_MAX, x));
  }
  function requestRepaint(){
    try{ if (CORE.paintAll) return CORE.paintAll(); }catch(_){}
  }
  // ---------- UI: stepper (CLEAN: arrows only) ----------
  function ensureStepperStyles(){
    if (document.getElementById("ct-bed-stepper-style")) return;
    const css = `
      #ct-bed-stepper-wrap{ display:inline-flex; align-items:center; gap:10px; }
      #ct-bed-stepper{
        display:inline-flex; align-items:center;
        padding:4px 7px; border-radius:999px;
        background:rgba(12,14,25,0.65);
        border:1px solid rgba(255,255,255,0.10);
        box-shadow:0 10px 24px rgba(0,0,0,0.45);
        backdrop-filter: blur(6px);
      }
      #ct-bed-stepper .ct-bed-btncol{ display:flex; flex-direction:column; gap:5px; }
      #ct-bed-stepper button{
        width:16px; height:12px; border-radius:6px;
        border:1px solid rgba(255,255,255,0.10);
        background:rgba(255,255,255,0.06);
        color:#e9ecff; cursor:pointer;
        display:flex; align-items:center; justify-content:center;
        line-height:1; user-select:none;
        font-size:9px;
        padding:0;
      }
      #ct-bed-stepper button:hover{
        border-color: rgba(142,243,197,0.55);
        box-shadow:0 0 0 1px rgba(142,243,197,0.18);
      }
      #ct-bed-stepper button:active{ transform: translateY(1px); }
    `.trim();
    const style = document.createElement("style");
    style.id = "ct-bed-stepper-style";
    style.textContent = css;
    document.head.appendChild(style);
  }
  function mountBedStepper(bedsEl, getAutoBeds){
    if (!bedsEl || !bedsEl.parentElement) return;
    ensureStepperStyles();
    let wrap = document.getElementById("ct-bed-stepper-wrap");
    if (!wrap){
      wrap = document.createElement("span");
      wrap.id = "ct-bed-stepper-wrap";
      const parent = bedsEl.parentElement;
      parent.insertBefore(wrap, bedsEl);
      wrap.appendChild(bedsEl);
      const stepper = document.createElement("span");
      stepper.id = "ct-bed-stepper";
      stepper.setAttribute("role","group");
      stepper.setAttribute("aria-label","Bedroom selector");
      stepper.innerHTML = `
        <span class="ct-bed-btncol">
          <button type="button" id="ct-bed-up" aria-label="Increase bedrooms">‚ñ≤</button>
          <button type="button" id="ct-bed-down" aria-label="Decrease bedrooms">‚ñº</button>
        </span>
      `;
      wrap.appendChild(stepper);
      const up = stepper.querySelector("#ct-bed-up");
      const dn = stepper.querySelector("#ct-bed-down");
      function applyDelta(delta){
        const autoBeds = clampBeds(getAutoBeds());
        const curBeds = readBedsOverride() ?? autoBeds;
        const next = clampBeds(curBeds + delta);
        writeBedsOverride(next);
        requestRepaint();
      }
      function resetToAuto(){
        writeBedsOverride(null);
        requestRepaint();
      }
      if (up) up.addEventListener("click", ()=> applyDelta(+1));
      if (dn) dn.addEventListener("click", ()=> applyDelta(-1));
      // wheel adjusts
      stepper.addEventListener("wheel", (ev)=>{
        ev.preventDefault();
        const delta = ev.deltaY > 0 ? -1 : +1;
        applyDelta(delta);
      }, { passive:false });
      // hidden reset: double-click (beds number OR arrow pill)
      bedsEl.addEventListener("dblclick", (ev)=>{ ev.preventDefault(); resetToAuto(); });
      stepper.addEventListener("dblclick", (ev)=>{ ev.preventDefault(); resetToAuto(); });
    }
  }
  // ---------- city name ----------
  function prettyCityName(){
    const city = CORE.brain?.city || {};
    const raw  = city?.raw || {};
    const dn = String(city.display_name || city.displayName || raw.display_name || raw.displayName || "").trim();
    if (dn) return dn;
    let place = String(
      pickFirst(raw, ["place","city","name","label","market_name","marketName"]) ||
      pickFirst(city, ["place","city","name","label","market_name","marketName"]) ||
      ""
    ).trim();
    if (place.includes(",")) place = place.split(",")[0].trim();
    if (place) return place;
    const k = String(city?.key || raw?.key || CORE.brain?.input?.cityKey || "").trim();
    return k ? k.replace(/[_-]+/g, " ").replace(/([a-z])([A-Z])/g, "$1 $2").trim() : "City";
  }
  function mortgageAssumptionsLine(bed){
    const a =
      bed?.mortgage_monthly?.assumptions ||
      bed?.mortgageMonthly?.assumptions ||
      bed?.mortgage?.assumptions ||
      null;
    if (!a || typeof a !== "object") return null;
    const parts = [];
    const apr = numFromAny(a.apr ?? a.apr_percent ?? a.rate ?? a.interest_rate);
    if (apr != null) parts.push(`${String(apr).includes(".") ? apr.toFixed(2).replace(/\.00$/,"") : apr}% APR`);
    const yrs = numFromAny(a.term_years ?? a.termYears ?? a.years);
    if (yrs != null) parts.push(`${Math.round(yrs)}y`);
    const dp = numFromAny(a.down_payment_pct ?? a.downPaymentPct ?? a.dp_pct);
    if (dp != null) parts.push(`${dp}% down`);
    const lt = String(a.loan_type ?? a.loanType ?? "").trim();
    if (lt) parts.push(lt);
    const extras = [];
    const tax = numFromAny(a.property_tax_rate_pct ?? a.propertyTaxRatePct ?? a.tax_rate_pct);
    if (tax != null) extras.push(`tax ${tax}%`);
    const ins = numFromAny(a.insurance_monthly ?? a.home_insurance_monthly ?? a.ins_monthly);
    if (ins != null) extras.push(`ins ${cur(ins,0)}/mo`);
    const hoa = numFromAny(a.hoa_monthly ?? a.hoa);
    if (hoa != null && hoa > 0) extras.push(`HOA ${cur(hoa,0)}/mo`);
    const pmi = numFromAny(a.pmi_monthly ?? a.pmi);
    if (pmi != null && pmi > 0) extras.push(`PMI ${cur(pmi,0)}/mo`);
    if (extras.length) parts.push(extras.join(" ‚Ä¢ "));
    return parts.length ? `Assumes ${parts.join(" ‚Ä¢ ")}` : null;
  }
  function getBedroomBlock(beds){
    const key = String(beds);
    const city = CORE.brain?.city || {};
    const raw  = city?.raw || {};
    const bedroomsRoot =
      city?.bedrooms || raw?.bedrooms ||
      city?.by_bedroom || raw?.by_bedroom ||
      city?.byBedroom || raw?.byBedroom ||
      null;
    if (!bedroomsRoot || typeof bedroomsRoot !== "object") return null;
    return bedroomsRoot[key] || bedroomsRoot[Number(key)] || null; // strict to this city only
  }
  function setNoPcsMode(reason){
    const titleEl = document.querySelector("#city-targets-card h3 span:first-child");
    if (titleEl) titleEl.textContent = "NO PCS Base Available";
    const sub = document.getElementById("ct-subtitle");
    if (sub) sub.textContent = reason || "Add a PCS base to your profile to load city targets.";
    setTileLabel(1, "Estimated Monthly Mortgage");
    setTileLabel(2, "Average Home Price");
    setTileLabel(3, "Average Rent Cost");
    setTileLabel(4, "Average Utilities Cost");
    hideGapPill();
    const mortgageEl = document.getElementById("ct-rent");
    const homeEl     = document.getElementById("ct-home");
    const rentEl     = document.getElementById("ct-target-home");
    const utilEl     = document.getElementById("ct-gap");
    if (mortgageEl) mortgageEl.textContent = "$‚Äî";
    if (homeEl)     homeEl.textContent     = "$‚Äî";
    if (rentEl)     rentEl.textContent     = "$‚Äî";
    if (utilEl)     utilEl.textContent     = "$‚Äî";
    const mortgageSub = document.getElementById("ct-rent-sub");
    const homeSub     = document.getElementById("ct-home-sub");
    const rentSub     = document.getElementById("ct-target-sub");
    const utilSub     = document.getElementById("ct-gap-sub");
    if (mortgageSub) mortgageSub.textContent = "No PCS base mapping ‚Üí cannot load city mortgage baseline.";
    if (homeSub)     homeSub.textContent     = "No PCS base mapping ‚Üí cannot load city home baseline.";
    if (rentSub)     rentSub.textContent     = "No PCS base mapping ‚Üí cannot load city rent baseline.";
    if (utilSub)     utilSub.textContent     = "No PCS base mapping ‚Üí cannot load city utilities baseline.";
    const copyEl = document.getElementById("ct-copy");
    if (copyEl){
      copyEl.textContent = "";
      copyEl.style.display = "none";
    }
  }
  function paintCityTargets(s){
    // ---- STOP infinite retry spam ----
    if ((!CORE.brain || !CORE.brain.ok) && CORE.fetchBrain){
      const now = Date.now();
      const last = Number(CORE.__CITY_BRAIN_RETRY_AT__ || 0);
      if ((now - last) > 30000 && !CORE.__CITY_RETRYING__){
        CORE.__CITY_RETRYING__ = true;
        CORE.__CITY_BRAIN_RETRY_AT__ = now;
        CORE.fetchBrain().finally(()=>{ CORE.__CITY_RETRYING__ = false; });
      }
    }
    const profile = getProfile();
    const base = getPcsBase(profile);
    if (!base){
      setNoPcsMode("NO PCS Base Available ‚Ä¢ Update your profile with a PCS base (e.g., Nellis AFB).");
      return;
    }
    const dbg = CORE.brain?.debug || {};
    const resolvedFromBase = !!String(dbg.baseUsedForCity || "").trim();
    const usedFallbackLoad = !!dbg.cityLoadFallbackUsed;
    if (!resolvedFromBase || usedFallbackLoad || !CORE.brain?.city){
      setNoPcsMode(`NO PCS Base Available ‚Ä¢ PCS base found (‚Äú${base}‚Äù), but city mapping was not resolved from base.`);
      return;
    }
    const titleEl = document.querySelector("#city-targets-card h3 span:first-child");
    if (titleEl) titleEl.textContent = `${prettyCityName()} Estimates`;
    const auto = deriveBedroomsFromFamily(profile);
    const override = readBedsOverride();
    const beds = clampBeds(override ?? auto.beds);
    const bedsEl = document.getElementById("ct-beds");
    if (bedsEl) bedsEl.textContent = String(beds);
    // ‚úÖ Clean arrows-only UI next to the number
    mountBedStepper(bedsEl, ()=> auto.beds);
    const sub = document.getElementById("ct-subtitle");
    if (sub){
      // keep it clean (no MANUAL/RESET language)
      sub.textContent = auto.fam
        ? `Derived from family size (${auto.fam}) ‚Ä¢ Auto: ${auto.beds}-bed`
        : `Derived bedrooms ‚Ä¢ Auto: ${auto.beds}-bed`;
    }
    const bed = getBedroomBlock(beds);
    setTileLabel(1, "Estimated Monthly Mortgage");
    setTileLabel(2, "Average Home Price");
    setTileLabel(3, "Average Rent Cost");
    setTileLabel(4, "Average Utilities Cost");
    hideGapPill();
    if (!bed){
      const mortgageEl = document.getElementById("ct-rent");
      const homeEl     = document.getElementById("ct-home");
      const rentEl     = document.getElementById("ct-target-home");
      const utilEl     = document.getElementById("ct-gap");
      if (mortgageEl) mortgageEl.textContent = "$‚Äî";
      if (homeEl)     homeEl.textContent     = "$‚Äî";
      if (rentEl)     rentEl.textContent     = "$‚Äî";
      if (utilEl)     utilEl.textContent     = "$‚Äî";
      const mortgageSub = document.getElementById("ct-rent-sub");
      const homeSub     = document.getElementById("ct-home-sub");
      const rentSub     = document.getElementById("ct-target-sub");
      const utilSub     = document.getElementById("ct-gap-sub");
      if (mortgageSub) mortgageSub.textContent = `No ${beds}-bed mortgage baseline in city JSON yet.`;
      if (homeSub)     homeSub.textContent     = `No ${beds}-bed home baseline in city JSON yet.`;
      if (rentSub)     rentSub.textContent     = `No ${beds}-bed rent baseline in city JSON yet.`;
      if (utilSub)     utilSub.textContent     = `No ${beds}-bed utilities baseline in city JSON yet.`;
      const copyEl = document.getElementById("ct-copy");
      if (copyEl){
        copyEl.textContent = "";
        copyEl.style.display = "none";
      }
      return;
    }
    const rentBlock = metricBlock(bed?.rent_monthly ?? bed?.rentMonthly ?? bed?.rent ?? bed?.rent_mo);
    const homeBlock = metricBlock(bed?.home_price  ?? bed?.homePrice  ?? bed?.price ?? bed?.home_value);
    const utilTotal = metricBlock(bed?.utilities?.total ?? bed?.utilities_total ?? bed?.utilities ?? bed?.utility);
    const mtgBlock  = metricBlock(bed?.mortgage_monthly ?? bed?.mortgageMonthly ?? bed?.mortgage ?? null);
    let rentAvg = numFromAny(rentBlock.avg); if (rentAvg==null) rentAvg = avgFromLowHigh(rentBlock.low, rentBlock.high);
    let homeAvg = numFromAny(homeBlock.avg); if (homeAvg==null) homeAvg = avgFromLowHigh(homeBlock.low, homeBlock.high);
    let utilAvg = numFromAny(utilTotal.avg); if (utilAvg==null) utilAvg = avgFromLowHigh(utilTotal.low, utilTotal.high);
    let mtgAvg  = numFromAny(mtgBlock.avg);  if (mtgAvg==null)  mtgAvg  = avgFromLowHigh(mtgBlock.low, mtgBlock.high);
    const rentLow = numFromAny(rentBlock.low), rentHigh = numFromAny(rentBlock.high);
    const homeLow = numFromAny(homeBlock.low), homeHigh = numFromAny(homeBlock.high);
    const utilLow = numFromAny(utilTotal.low), utilHigh = numFromAny(utilTotal.high);
    const rentAsOf = rentBlock.as_of || rentBlock.asOf || null;
    const homeAsOf = homeBlock.as_of || homeBlock.asOf || null;
    const utilAsOf = bed?.utilities?.as_of || bed?.utilities?.asOf || utilTotal.as_of || utilTotal.asOf || null;
    const egAvg = numFromAny(bed?.utilities?.electric_gas?.avg ?? bed?.utilities?.electricGas?.avg);
    const wsAvg = numFromAny(bed?.utilities?.water_sewer?.avg ?? bed?.utilities?.waterSewer?.avg);
    // In-city fallback only (no city switching)
    const city = CORE.brain?.city || {};
    const raw  = city?.raw || {};
    const market = city?.market || raw?.market || {};
    if (homeAvg == null){
      const v =
        pickFirst(raw, ["avg_home_value","average_home_value","avgHome","city_avg_home"]) ??
        pickFirst(market, ["avg_home_value","average_home_value","avgHome","city_avg_home"]) ??
        deepPick(city, ["avg_home_value","average_home_value","avgHome","city_avg_home","zillow_average_home_value","median_sale_price_current"]);
      const n = numFromAny(v);
      if (n!=null) homeAvg = n;
    }
    if (rentAvg == null && homeAvg != null && homeAvg > 0){
      rentAvg = Math.round(homeAvg * 0.01);
    }
    if (utilAvg == null){
      utilAvg = utilitiesFromBridge();
    }
    const dashHousing = Math.max(0, Number(s.housing)||0);
    const brainMortgage = Math.max(0,
      Number(CORE.brain?.estimatedMonthlyMortgage || 0) ||
      Number(CORE.brain?.mortgage?.totalMonthly || 0) ||
      0
    );
    const mortgageEst =
      (mtgAvg != null && mtgAvg > 0) ? mtgAvg :
      (dashHousing > 0 ? dashHousing : brainMortgage);
    const mortgageEl = document.getElementById("ct-rent");
    const homeEl     = document.getElementById("ct-home");
    const rentEl     = document.getElementById("ct-target-home");
    const utilEl     = document.getElementById("ct-gap");
    if (mortgageEl) mortgageEl.textContent = mortgageEst>0 ? cur(mortgageEst,0) : "$‚Äî";
    if (homeEl)     homeEl.textContent     = (homeAvg && homeAvg>0) ? cur(homeAvg,0) : "$‚Äî";
    if (rentEl)     rentEl.textContent     = (rentAvg && rentAvg>0) ? cur(rentAvg,0) : "$‚Äî";
    if (utilEl)     utilEl.textContent     = (utilAvg && utilAvg>0) ? cur(utilAvg,0) : "$‚Äî";
    const mortgageSub = document.getElementById("ct-rent-sub");
    const homeSub     = document.getElementById("ct-home-sub");
    const rentSub     = document.getElementById("ct-target-sub");
    const utilSub     = document.getElementById("ct-gap-sub");
    if (mortgageSub){
      const assumptions = mortgageAssumptionsLine(bed);
      mortgageSub.textContent =
        assumptions ||
        (dashHousing > 0
          ? "Assumes your dashboard model inputs (price/APR/term/overrides)."
          : (brainMortgage > 0 ? "Assumes brain estimate." : "Mortgage assumptions not available yet."));
    }
    if (homeSub){
      const rng = fmtMoneyRange(homeLow, homeHigh);
      homeSub.textContent = rng ? `Range: ${rng}${homeAsOf ? ` ‚Ä¢ As of ${homeAsOf}` : ""}` : "From city baseline";
    }
    if (rentSub){
      const rng = fmtMoneyRange(rentLow, rentHigh);
      rentSub.textContent = rng ? `Range: ${rng}${rentAsOf ? ` ‚Ä¢ As of ${rentAsOf}` : ""}` : "From city baseline (or 1% fallback)";
    }
    if (utilSub){
      const rng = fmtMoneyRange(utilLow, utilHigh);
      const parts = [];
      if (egAvg!=null) parts.push(`Electric+Gas avg ${cur(egAvg,0)}`);
      if (wsAvg!=null) parts.push(`Water+Sewer avg ${cur(wsAvg,0)}`);
      const breakdown = parts.length ? `Includes ${parts.join(" ‚Ä¢ ")}` : "Includes electric/gas + water/sewer";
      utilSub.textContent = rng ? `Range: ${rng}${utilAsOf ? ` ‚Ä¢ As of ${utilAsOf}` : ""} ‚Ä¢ ${breakdown}` : `${breakdown} ‚Ä¢ From baseline`;
    }
    const copyEl = document.getElementById("ct-copy");
    if (copyEl){
      copyEl.textContent = "";
      copyEl.style.display = "none";
    }
  }
  CORE.registerPainter("city-estimates", ({ s }) => paintCityTargets(s));
})();
</script>
  </div>
  <div class="w-embed w-script">
    <script>
(() => {
  "use strict";
  /* ============================================================
    RS ‚Ä¢ 2D (REPLACEMENT) ‚Äî BLUF RUNTIME v1.0.2
    ‚úÖ Reads the SAME displayed dashboard numbers as 2A
    ‚úÖ No /api/bluf call (prevents flicker + mismatch)
    ‚úÖ No double-counting housing
    ‚úÖ Writes a shared verdict object to localStorage for reuse
  ============================================================ */
  if (window.__RS_BLUF_2D_V102__) return;
  window.__RS_BLUF_2D_V102__ = true;
  const blufEl = document.getElementById("ec-blufText");
  const tagEl  = document.getElementById("ec-blufTag");
  if (!blufEl) return;
  const LS_VERDICT = "realtysass.ec_verdict.v1";
  function safeJSON(key, fallback){
    try{ return JSON.parse(localStorage.getItem(key) || "null") ?? fallback; }
    catch(_){ return fallback; }
  }
  function fmtUSD(n){
    const num = Number(n || 0);
    try{
      return new Intl.NumberFormat(undefined, { style:"currency", currency:"USD", maximumFractionDigits:0 }).format(num);
    }catch(_){
      return "$" + Math.round(num).toLocaleString();
    }
  }
  function parseMoneyText(txt){
    const n = Number(String(txt || "").replace(/[^0-9.-]/g,""));
    return Number.isFinite(n) ? n : 0;
  }
  function readElMoney(id){
    const el = document.getElementById(id);
    if (!el) return 0;
    return parseMoneyText(el.textContent);
  }
  function readDerivedMortgage(){
    // 1) CORE state (best)
    const CORE = window.RS_FID;
    const st = CORE && CORE.state ? CORE.state : null;
    const candidates = [
      st?.__rsMonthlyMortgage,
      st?.mortgageMonthly,
      st?.housingMonthly,
      st?.monthlyMortgage,
      st?.allInMortgage,
      st?.mortgageAllIn
    ].map(Number).filter(n => Number.isFinite(n) && n > 0);
    if (candidates.length) return candidates[0];
    // 2) Known LS derived key (2B writes this)
    const derived = safeJSON("realtysass.derived.housing_monthly.v1", null);
    const dNum = Number(derived?.monthly || derived?.housingMonthly || derived?.value || derived || 0);
    if (Number.isFinite(dNum) && dNum > 0) return dNum;
    // 3) mortgage_cache (2A caches mortgage.js results)
    const mc = safeJSON("realtysass.mortgage_cache.v1", null);
    const maybeAllIn =
      Number(mc?.allInMonthly || mc?.all_in_monthly || mc?.result?.allInMonthly || mc?.response?.allInMonthly || 0);
    if (Number.isFinite(maybeAllIn) && maybeAllIn > 0) return maybeAllIn;
    // 4) DOM fallback: 2A paints mortgage estimate into feasibility area
    // Try both places and pick the most ‚Äúmortgage-like‚Äù value.
    const a = readElMoney("fs-residual");
    const b = readElMoney("fs-housing");
    const picks = [a,b].filter(n => Number.isFinite(n) && n > 0);
    if (!picks.length) return 0;
    // Prefer the one that looks like a monthly mortgage (usually 300‚Äì15000)
    const inRange = picks.filter(n => n >= 300 && n <= 15000);
    return (inRange.length ? inRange[0] : picks[0]) || 0;
  }
  function computeBluf(){
    // Always use the KPIs the user actually sees/edits:
    const income   = readElMoney("k-income");   // KPI #1
    const expenses = readElMoney("k-expense");  // KPI #2 (base expenses, NOT including mortgage)
    const housing  = readDerivedMortgage();     // mortgage.js all-in monthly, as painted by 2A
    if (!income || income <= 0){
      return { status:"NEEDS PROFILE", bluf:"NEEDS PROFILE: unlock and load your email so pay tables can produce a deterministic verdict.", income, expenses, housing };
    }
    if (!housing || housing <= 0){
      return { status:"SET HOUSING", bluf:"SET HOUSING: enter a target home price + downpayment so the mortgage estimate can drive the verdict.", income, expenses, housing };
    }
    const cap = income * 0.30; // safe housing cap (matches your current dashboard behavior)
    const buffer = income - expenses - housing;
    const pct = income > 0 ? (buffer / income) : 0;
    // Decide status
    let status = "GREEN";
    if (housing > cap) status = "NO-GO";
    else if (buffer < income * 0.08) status = "CAUTION";
    // Compose BLUF (stable + consistent)
    let bluf = "";
    if (status === "NO-GO"){
      bluf = `NO-GO: Housing is ${fmtUSD(housing)}/mo vs a safe cap of ${fmtUSD(cap)}/mo. Reduce by ~${fmtUSD(housing - cap)}.`;
    } else if (status === "CAUTION"){
      bluf = `CAUTION: Housing fits the cap, but your buffer after bills is ~${fmtUSD(buffer)}/mo (${Math.round(pct*100)}% of income).`;
    } else {
      bluf = `GREEN: Housing fits the cap and your buffer after bills is ~${fmtUSD(buffer)}/mo (${Math.round(pct*100)}% of income).`;
    }
    return { status, bluf, income, expenses, housing, cap, buffer, pct };
  }
  function paint(out){
    // Tag shows status (matches your screenshot vibe)
    if (tagEl){
      const t = String(out.status || "BLUF").toUpperCase();
      tagEl.textContent = t;
    }
    blufEl.textContent = String(out.bluf || "Loading verdict‚Ä¶");
    try{
      localStorage.setItem(LS_VERDICT, JSON.stringify({
        ts: Date.now(),
        ok: true,
        status: out.status,
        bluf: out.bluf,
        income: out.income,
        expenses: out.expenses,
        housingMonthly: out.housing,
        cap: out.cap,
        buffer: out.buffer,
        pct: out.pct
      }));
    }catch(_){}
  }
  let LAST_SIG = "";
  function sig(out){
    const r = (x)=>Math.round(Number(x||0));
    return [r(out.income), r(out.expenses), r(out.housing)].join("|");
  }
  function tick(){
    const out = computeBluf();
    const s = sig(out);
    if (s !== LAST_SIG){
      LAST_SIG = s;
      paint(out);
    }
  }
  // Fast initial paint from last stored verdict (prevents ‚Äúblank‚Äù)
  const cached = safeJSON(LS_VERDICT, null);
  if (cached?.bluf){
    if (tagEl && cached?.status) tagEl.textContent = String(cached.status).toUpperCase();
    blufEl.textContent = String(cached.bluf);
  } else {
    blufEl.textContent = "Loading verdict‚Ä¶";
  }
  // React to your system events (instant updates)
  window.addEventListener("message", () => tick(), false);
  // Slow loop as a safety net
  setInterval(tick, 450);
  tick();
})();
</script>
  </div>
  <div class="w-embed w-script">
    <script>
(() => {
  "use strict";
  // ============================================================
  // RS_FID ‚Ä¢ EMBED 2E ‚Äî RENT vs BUY (Equity + Break-even + Drag Cursor)
  // - Uses existing Shell IDs:
  //   canvas#fid-line, #rvb-gain, #rvb-rentCost
  // - Injects Break-even label into the footer (no Shell edits needed)
  // ============================================================
  if (window.RS_RVB_2E && window.RS_RVB_2E.__mounted) return;
  // ----------------------------
  // //#1 Helpers
  // ----------------------------
  const money0 = (n) => {
    const x = Number(n);
    if (!Number.isFinite(x)) return "$‚Äî";
    return x.toLocaleString("en-US", { style:"currency", currency:"USD", maximumFractionDigits:0 });
  };
  const numFromText = (txt) => {
    const n = Number(String(txt || "").replace(/[^0-9.-]/g, ""));
    return Number.isFinite(n) ? n : 0;
  };
  const getEl = (id) => document.getElementById(id);
  const readJSON = (key) => {
    try { return JSON.parse(localStorage.getItem(key) || "null"); } catch(e){ return null; }
  };
  function pmti(P, r, n){
    if (!P || !n) return 0;
    if (r === 0) return P / n;
    const x = Math.pow(1 + r, n);
    return P * (r * x) / (x - 1);
  }
  function aprFromScore(score){
    const s = Number(score) || 720;
    if (s >= 780) return 6.50;
    if (s >= 740) return 6.90;
    if (s >= 700) return 7.20;
    if (s >= 660) return 7.80;
    return 8.50;
  }
  // ----------------------------
  // //#2 Pull snapshot inputs from RS_FID + localStorage + DOM
  // ----------------------------
  function buildSnapshot(){
    const CORE = window.RS_FID || null;
    const ov = readJSON("realtysass.kpi_overrides.v1") || {};
    const mortCache = readJSON("realtysass.mortgage_cache.v1") || {};
    const derivedMortgage = readJSON("realtysass.derived.housing_monthly.v1") || null;
    // Price = Housing Cost KPI (this is purchase price, not monthly)
    let price =
      (CORE && CORE.state && Number(CORE.state.housingOverride)) ||
      Number(ov.housingOverride) ||
      numFromText(getEl("k-mtg")?.textContent) ||
      350000;
    // Downpayment amount
    let dpAmt =
      (CORE && CORE.state && (Number(CORE.state.savingsOverride) || Number(CORE.state.savings))) ||
      Number(ov.savingsOverride) ||
      numFromText(getEl("k-save")?.textContent) ||
      Math.round(price * 0.05);
    // Credit score -> APR fallback
    const score =
      (CORE && CORE.state && Number(CORE.state.creditScore)) ||
      Number(ov.creditScore) ||
      numFromText(getEl("k-score")?.textContent) ||
      720;
    // Mortgage cache can be shaped differently depending on your mortgage.js response.
    // Try multiple likely keys.
    const mc = mortCache && (mortCache.data || mortCache.payload || mortCache) || {};
    const apr =
      Number(mc.apr) ||
      Number(mc.aprPercent) ||
      Number(mc.rate) ||
      aprFromScore(score);
    const termYears =
      Number(mc.termYears) ||
      Number(mc.term) ||
      30;
    // Monthly components (preferred from mortgage.js)
    const pi =
      Number(mc.piMonthly) ||
      Number(mc.pi) ||
      0;
    const tax =
      Number(mc.taxMonthly) ||
      (Number(mc.taxAnnual) ? Number(mc.taxAnnual)/12 : 0) ||
      0;
    const ins =
      Number(mc.insuranceMonthly) ||
      (Number(mc.insuranceAnnual) ? Number(mc.insuranceAnnual)/12 : 0) ||
      0;
    const hoa =
      Number(mc.hoaMonthly) ||
      0;
    const pmi =
      Number(mc.pmiMonthly) ||
      Number(mc.pmi) ||
      0;
    // All-in monthly mortgage (fallback to derived/local DOM if cache missing)
    const allIn =
      Number(mc.allInMonthly) ||
      Number(mc.monthly) ||
      Number(derivedMortgage) ||
      numFromText(getEl("fs-housing")?.textContent) ||
      0;
    // If we have no tax/ins/hoa, create a conservative baseline so equity model isn't nonsense.
    // (Only used when mortgage.js didn't supply details.)
    let tihoa = (tax + ins + hoa);
    if (!tihoa && price){
      const taxMo = (price * 0.0115) / 12;   // ~1.15% property tax
      const insMo = (price * 0.0040) / 12;   // ~0.40% insurance
      const hoaMo = 0;                       // unknown
      tihoa = taxMo + insMo + hoaMo;
    }
    // If PI is missing but we have APR/term, compute PI from price/dp.
    // Loan amount:
    const loan0 = Math.max(0, price - dpAmt);
    const r_m = (apr / 100) / 12;
    const nTot = termYears * 12;
    let piMo = pi;
    if (!piMo && loan0 > 0){
      piMo = pmti(loan0, r_m, nTot);
    }
    // Rent monthly: prefer City Target Rent tile (ct-rent) if available
    let rentMonthly =
      numFromText(getEl("ct-rent")?.textContent) ||
      0;
    // If ct-rent is empty, use a baseline rent heuristic (1% rule-ish)
    if (!rentMonthly){
      rentMonthly = Math.max(1200, Math.round((price * 0.0095)));
    }
    return {
      price,
      dpAmt,
      apr,
      termYears,
      tihoa,    // monthly taxes+insurance+hoa combined
      pmi,      // monthly
      piMo,     // monthly PI
      allIn,    // monthly all-in
      rentMonthly
    };
  }
  // ----------------------------
  // //#3 Equity-aware Rent vs Buy Model (10 years)
  // ----------------------------
  const MODEL = {
    CLOSE_PCT: 0.03,  // 3% closing costs
    SELL_PCT:  0.07,  // 7% selling costs
    APP_Y:     0.03,  // 3%/yr appreciation
    RENT_Y:    0.03,  // 3%/yr rent growth
    INVRET_Y:  0.05,  // 5%/yr alt investment return on cash
    MAINT_Y:   0.01   // 1%/yr maintenance
  };
  function buildSeries10Y(s){
    const Y = 10;
    const N = Y * 12;
    const labels = Array.from({ length: Y + 1 }, (_, i) => i === 0 ? "T" : `${i}Y`);
    const price = Math.max(150000, Number(s.price) || 350000);
    const down  = Math.max(0, Number(s.dpAmt) || 0);
    const loan0 = Math.max(0, price - down);
    const apr = Number(s.apr) || 7.0;
    const termYears = Number(s.termYears) || 30;
    const r_m = (apr / 100) / 12;
    const nTot = termYears * 12;
    // Use PI from snapshot if trustworthy, else compute
    const piMo = Number(s.piMo) || (loan0 > 0 ? pmti(loan0, r_m, nTot) : 0);
    const tihoa = Number(s.tihoa) || 0;
    const pmi   = Number(s.pmi) || 0;
    const maintMo = (price * MODEL.MAINT_Y) / 12;
    const closing = price * MODEL.CLOSE_PCT;
    const upfront = down + closing;
    const rent0 = Math.max(0, Number(s.rentMonthly) || 0);
    const rent_g_m = Math.pow(1 + MODEL.RENT_Y, 1/12) - 1;
    const appr_m = Math.pow(1 + MODEL.APP_Y, 1/12) - 1;
    const inv_m  = Math.pow(1 + MODEL.INVRET_Y, 1/12) - 1;
    let bal = loan0;
    let homeVal = price;
    let cumRent = 0;
    let cumOwner = upfront;
    // Alternative investment: renter invests the downpayment (opportunity cost model)
    let altInvest = down;
    const buySeries = [upfront];
    const rentSeries = [0];
    const equityByYear = [down];
    const cumRentByYear = [0];
    let beMonth = null;
    for (let m = 1; m <= N; m++){
      // RENT: pay rent, rent grows, invested cash grows
      const rent_m = rent0 * Math.pow(1 + rent_g_m, m - 1);
      cumRent += rent_m;
      altInvest *= (1 + inv_m);
      // BUY: amortization + all-in owner costs
      const interest  = bal * r_m;
      const principal = Math.max(0, piMo - interest);
      bal = Math.max(0, bal - principal);
      cumOwner += (piMo + tihoa + pmi + maintMo);
      // Appreciation
      homeVal *= (1 + appr_m);
      const equity = Math.max(0, homeVal - bal);
      const sellCost = homeVal * MODEL.SELL_PCT;
      const netIfSold = Math.max(homeVal - sellCost - bal, 0);
      // Net costs:
      // - BuyNet = what you paid (cumOwner) minus what you could walk away with if sold now (netIfSold)
      const buyNet = Math.max(0, cumOwner - netIfSold);
      // - RentNet = rent paid minus net growth of invested downpayment cash (altInvest - down)
      const rentNet = Math.max(0, cumRent - (altInvest - down));
      if (beMonth === null && buyNet <= rentNet) beMonth = m;
      if (m % 12 === 0){
        buySeries.push(buyNet);
        rentSeries.push(rentNet);
        equityByYear.push(equity);
        cumRentByYear.push(cumRent);
      }
    }
    const beYears = (beMonth !== null) ? (beMonth / 12) : null;
    return {
      labels,
      buySeries,
      rentSeries,
      equityByYear,
      cumRentByYear,
      beYears
    };
  }
  // ----------------------------
  // //#4 Chart + Drag Cursor Plugin
  // ----------------------------
  let chart = null;
  let selectedIndex = 1; // default to 1Y
  let lastSeries = null;
  let lastSnap = null;
  function ensureBreakEvenBadge(){
    const footer = getEl("rentbuy-card")?.querySelector(".rvb-footer");
    if (!footer) return;
    if (!getEl("rvb-be")){
      const wrap = document.createElement("div");
      wrap.className = "rvb-metric";
      wrap.innerHTML = `Break-even: <b id="rvb-be">‚Äî</b>`;
      footer.insertBefore(wrap, footer.children[1] || null);
    }
  }
  const cursorPlugin = {
    id: "rsRvbCursor",
    afterDatasetsDraw(c, args, opts){
      try{
        const meta = c.getDatasetMeta(0);
        if (!meta || !meta.data || !meta.data.length) return;
        const idx = Math.max(0, Math.min(selectedIndex, meta.data.length - 1));
        const pt = meta.data[idx];
        if (!pt) return;
        const { ctx, chartArea } = c;
        const x = pt.x;
        ctx.save();
        ctx.strokeStyle = "rgba(255,255,255,0.35)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x, chartArea.top);
        ctx.lineTo(x, chartArea.bottom);
        ctx.stroke();
        // Label pill
        const label = idx === 0 ? "T" : `Year ${idx}`;
        const padX = 10, padY = 6;
        ctx.font = "800 11px Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial";
        const w = ctx.measureText(label).width + padX*2;
        const h = 24;
        let lx = x - w/2;
        lx = Math.max(chartArea.left + 6, Math.min(lx, chartArea.right - w - 6));
        const ly = chartArea.top + 10;
        // Rounded rect
        const r = 10;
        ctx.fillStyle = "rgba(0,0,0,0.55)";
        ctx.strokeStyle = "rgba(255,255,255,0.18)";
        ctx.beginPath();
        ctx.moveTo(lx + r, ly);
        ctx.arcTo(lx + w, ly, lx + w, ly + h, r);
        ctx.arcTo(lx + w, ly + h, lx, ly + h, r);
        ctx.arcTo(lx, ly + h, lx, ly, r);
        ctx.arcTo(lx, ly, lx + w, ly, r);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        ctx.fillStyle = "rgba(255,255,255,0.92)";
        ctx.textBaseline = "middle";
        ctx.fillText(label, lx + padX, ly + h/2);
        ctx.restore();
      }catch(e){}
    }
  };
  function initChart(){
    const canvas = getEl("fid-line");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label:"Buying ‚Äî Net Cost",
            data: [],
            tension: 0.35,
            fill: false,
            borderWidth: 2,
            pointRadius: 0,
            borderColor: "#6aa7ff"
          },
          {
            label:"Renting ‚Äî Net Cost",
            data: [],
            tension: 0.35,
            fill: false,
            borderWidth: 2,
            pointRadius: 0,
            borderColor: "#ff5c8a"
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode:"index", intersect:false },
        plugins: {
          legend: {
            display: true,
            labels: { color:"#fff", boxWidth:12, boxHeight:12 }
          },
          tooltip: {
            callbacks: {
              label: (item) => {
                const base = `${item.dataset.label}: ${money0(item.raw)}`;
                const idx = item.dataIndex;
                if (lastSeries && item.datasetIndex === 0){
                  const eq = lastSeries.equityByYear?.[idx] || 0;
                  return [base, `Equity (est): ${money0(eq)}`];
                }
                if (lastSeries && item.datasetIndex === 1){
                  const cr = lastSeries.cumRentByYear?.[idx] || 0;
                  return [base, `Cumulative rent paid: ${money0(cr)}`];
                }
                return base;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color:"rgba(255,255,255,0.75)", font:{ weight:700 } },
            grid: { color:"rgba(255,255,255,0.06)" }
          },
          y: {
            ticks: {
              color:"rgba(255,255,255,0.75)",
              callback: (v) => {
                const n = Number(v) || 0;
                if (n >= 1000000) return (n/1000000).toFixed(1) + "M";
                if (n >= 1000) return (n/1000).toFixed(0) + "K";
                return String(n);
              }
            },
            grid: { color:"rgba(255,255,255,0.08)" }
          }
        }
      },
      plugins: [cursorPlugin]
    });
    // Drag handler (mouse/touch/pointer)
    let dragging = false;
    const setIdxFromEvent = (ev) => {
      if (!chart) return;
      const e = ev.touches ? ev.touches[0] : ev;
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left);
      const xScale = chart.scales.x;
      if (!xScale) return;
      // Find closest tick/index by pixel
      const pixels = chart.getDatasetMeta(0).data.map(p => p.x);
      let best = 0;
      let bestD = Infinity;
      for (let i=0; i<pixels.length; i++){
        const d = Math.abs(pixels[i] - (xScale.left + x));
        if (d < bestD){ bestD = d; best = i; }
      }
      selectedIndex = best;
      chart.update("none");
      paintFooter();
    };
    canvas.addEventListener("pointerdown", (ev) => {
      dragging = true;
      canvas.setPointerCapture?.(ev.pointerId);
      setIdxFromEvent(ev);
    });
    canvas.addEventListener("pointermove", (ev) => {
      if (!dragging) return;
      setIdxFromEvent(ev);
    });
    window.addEventListener("pointerup", () => { dragging = false; }, { passive:true });
    // Touch fallback (older iOS webviews)
    canvas.addEventListener("touchstart", (ev) => { dragging = true; setIdxFromEvent(ev); }, { passive:true });
    canvas.addEventListener("touchmove",  (ev) => { if (dragging) setIdxFromEvent(ev); }, { passive:true });
    window.addEventListener("touchend",   () => { dragging = false; }, { passive:true });
  }
  // ----------------------------
  // //#5 Paint (Chart + Footer + Break-even)
  // ----------------------------
  function paintFooter(){
    const gainEl = getEl("rvb-gain");
    const rentEl = getEl("rvb-rentCost");
    const beEl   = getEl("rvb-be");
    if (!lastSeries) {
      if (gainEl) gainEl.textContent = "‚Äî";
      if (rentEl) rentEl.textContent = "‚Äî";
      if (beEl)   beEl.textContent   = "‚Äî";
      return;
    }
    const idx = Math.max(0, Math.min(selectedIndex, lastSeries.labels.length - 1));
    const buyNet  = Number(lastSeries.buySeries[idx])  || 0;
    const rentNet = Number(lastSeries.rentSeries[idx]) || 0;
    // ‚úÖ Gain definition: positive means BUYING wins (rent net cost - buy net cost)
    const gain = rentNet - buyNet;
    if (gainEl) gainEl.textContent = (gain >= 0 ? "" : "‚àí") + money0(Math.abs(gain));
    if (rentEl) rentEl.textContent = money0(rentNet);
    if (beEl){
      if (lastSeries.beYears == null) {
        beEl.textContent = "‚Äî";
      } else {
        const y = lastSeries.beYears;
        const years = Math.floor(y);
        const months = Math.round((y - years) * 12);
        const label = (years === 0)
          ? `${months} mo`
          : `${years}y ${months}mo`;
        beEl.textContent = label.replace(" 0mo", "");
      }
    }
  }
  function paintAll(){
    if (!chart) initChart();
    if (!chart) return;
    ensureBreakEvenBadge();
    const snap = buildSnapshot();
    lastSnap = snap;
    // Build equity-aware series
    const series = buildSeries10Y(snap);
    lastSeries = series;
    // Keep cursor index in range
    if (selectedIndex > series.labels.length - 1) selectedIndex = series.labels.length - 1;
    if (selectedIndex < 0) selectedIndex = 0;
    chart.data.labels = series.labels;
    chart.data.datasets[0].data = series.buySeries;
    chart.data.datasets[1].data = series.rentSeries;
    chart.update();
    paintFooter();
  }
  // ----------------------------
  // //#6 Hooks: refresh when RS_FID updates
  // ----------------------------
  let rafLock = false;
  const schedulePaint = () => {
    if (rafLock) return;
    rafLock = true;
    requestAnimationFrame(() => {
      rafLock = false;
      paintAll();
    });
  };
  // a) Listen for feasibility publish (your core runtime posts this)
  window.addEventListener("message", (ev) => {
    try{
      const d = ev?.data || {};
      if (d && d.type === "realtysass-feasibility") schedulePaint();
    }catch(e){}
  });
  // b) Soft poll fallback (covers first load + any missed events)
  let lastKey = "";
  setInterval(() => {
    const ov = readJSON("realtysass.kpi_overrides.v1") || {};
    const mc = readJSON("realtysass.mortgage_cache.v1") || {};
    const sig = JSON.stringify({
      h: ov.housingOverride, s: ov.savingsOverride, c: ov.creditScore,
      m: mc && (mc.key || mc.__key || mc.ts || mc.updatedAt || null)
    });
    if (sig !== lastKey){
      lastKey = sig;
      schedulePaint();
    }
  }, 900);
  // Boot
  schedulePaint();
  // Public handle (optional)
  window.RS_RVB_2E = {
    __mounted: true,
    repaint: schedulePaint,
    getSnapshot: () => ({ ...(lastSnap || {}) }),
    getSeries: () => ({ ...(lastSeries || {}) })
  };
})();
</script>
  </div>
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=69658389f59da527c04bcbd4" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="js/webflow.js" type="text/javascript"></script>
</body>
</html>